import {migrate}from'drizzle-orm/postgres-js/migrator';import {drizzle}from'drizzle-orm/postgres-js';import Qe from'postgres';import {pgEnum,pgTable,timestamp,boolean,text,uuid,integer,jsonb,date,numeric,time,index,uniqueIndex,check,inet}from'drizzle-orm/pg-core';import {relations,sql}from'drizzle-orm';import Xe from'dotenv';var Ne=Object.defineProperty;var we=(e,w)=>{for(var re in w)Ne(e,re,{get:w[re],enumerable:true});};var oe={};we(oe,{adjustmentTypeEnum:()=>$,auditLogs:()=>We,availability:()=>Re,availabilityStatusEnum:()=>B,bookingStatusEnum:()=>M,bookings:()=>g,cancellationPolicies:()=>ze,cancellationTypeEnum:()=>G,cancelledByEnum:()=>O,customerProfiles:()=>Te,idTypeEnum:()=>I,mediaTypeEnum:()=>C,messages:()=>Fe,notificationChannelEnum:()=>H,notifications:()=>Le,ownerProfiles:()=>ve,paymentMethodEnum:()=>F,paymentStatusEnum:()=>D,paymentTxnStatusEnum:()=>L,payments:()=>Pe,payoutStatusEnum:()=>he,priceRuleTypeEnum:()=>V,priceRules:()=>Se,reviews:()=>Oe,sessions:()=>Ee,stayIntentEnum:()=>j,stayMedia:()=>T,stayMediaRelations:()=>je,stayStatusEnum:()=>P,stayTypeEnum:()=>K,stayUnits:()=>l,stayUnitsRelations:()=>Ke,stays:()=>r,staysRelations:()=>qe,supportMessages:()=>Ve,supportTickets:()=>fe,ticketCategoryEnum:()=>W,ticketPriorityEnum:()=>J,ticketStatusEnum:()=>Q,unitTypeEnum:()=>U,userRoleEnum:()=>S,users:()=>i,verificationStatusEnum:()=>q});var S=pgEnum("user_role",["customer","owner","admin"]),q=pgEnum("verification_status",["pending","verified","rejected"]),I=pgEnum("id_type",["citizenship","national_id_card","passport","national_id"]),K=pgEnum("stay_type",["hotel","homestay","apartment","room","hostel"]),j=pgEnum("stay_intent",["short_stay","long_stay","both"]),P=pgEnum("stay_status",["draft","pending_review","active","suspended","archived"]),U=pgEnum("unit_type",["private_room","shared_room","entire_place","bed"]),B=pgEnum("availability_status",["available","blocked","booked"]),C=pgEnum("media_type",["image","video"]),M=pgEnum("booking_status",["initiated","reserved","confirmed","checked_in","completed","cancelled","expired","no_show","pending"]),D=pgEnum("payment_status",["not_required","pending","success","failed","refunded","unpaid","paid"]),O=pgEnum("cancelled_by",["customer","owner","admin","system"]),F=pgEnum("payment_method",["khalti","esewa","bank_transfer","cash","wallet"]),L=pgEnum("payment_txn_status",["initiated","pending","completed","failed","refunded"]),V=pgEnum("price_rule_type",["seasonal","weekend","holiday","long_stay","last_minute"]),$=pgEnum("adjustment_type",["fixed","percent"]),G=pgEnum("cancellation_type",["flexible","moderate","strict","non_refundable"]),he=pgEnum("payout_status",["pending","processing","completed","failed"]),H=pgEnum("notification_channel",["in_app","email","sms","push"]),W=pgEnum("ticket_category",["booking","payment","property","account","other"]),J=pgEnum("ticket_priority",["low","medium","high","urgent"]),Q=pgEnum("ticket_status",["open","in_progress","waiting_customer","resolved","closed"]);var i=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull().unique(),phone:text("phone").unique(),fullName:text("full_name").notNull(),avatarUrl:text("avatar_url"),role:S("role").default("customer").notNull(),password:text("password"),emailVerified:boolean("email_verified").default(false),phoneVerified:boolean("phone_verified").default(false),isActive:boolean("is_active").default(true),lastLoginAt:timestamp("last_login_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),ve=pgTable("owner_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>i.id).notNull().unique(),nationality:text("nationality").default("Nepali"),businessName:text("business_name"),panNumber:text("pan_number"),idType:I("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),bankName:text("bank_name"),bankAccount:text("bank_account"),address:text("address"),verificationStatus:q("verification_status").default("pending"),totalEarnings:integer("total_earnings").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Te=pgTable("customer_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>i.id).notNull().unique(),dateOfBirth:date("date_of_birth"),nationality:text("nationality").default("Nepali"),idType:I("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),emergencyContact:text("emergency_contact"),preferences:jsonb("preferences").default({}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Ee=pgTable("sessions",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>i.id).notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}).notNull(),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var r=pgTable("stays",{id:uuid("id").defaultRandom().primaryKey(),ownerId:uuid("owner_id").references(()=>i.id).notNull(),name:text("name").notNull(),slug:text("slug").notNull().unique(),description:text("description"),type:K("type").notNull(),intent:j("intent").default("both"),status:P("status").default("draft"),addressLine:text("address_line").notNull(),city:text("city").notNull(),district:text("district").notNull(),province:text("province"),latitude:numeric("latitude",{precision:10,scale:7}),longitude:numeric("longitude",{precision:10,scale:7}),basePrice:integer("base_price").notNull(),maxGuests:integer("max_guests").default(2),amenities:jsonb("amenities").default([]),rules:jsonb("rules").default([]),checkInTime:time("check_in_time").default("14:00:00"),checkOutTime:time("check_out_time").default("11:00:00"),avgRating:numeric("avg_rating",{precision:2,scale:1}).default("0"),totalReviews:integer("total_reviews").default(0),totalBookings:integer("total_bookings").default(0),isFeatured:boolean("is_featured").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()},e=>({ownerIdIdx:index("stay_owner_id_idx").on(e.ownerId)})),l=pgTable("stay_units",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>r.id).notNull(),name:text("name").notNull(),type:U("type").notNull(),maxOccupancy:integer("max_occupancy").default(2).notNull(),basePrice:integer("base_price").notNull(),quantity:integer("quantity").default(1),amenities:jsonb("amenities").default([]),isActive:boolean("is_active").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({stayIdIdx:index("stay_unit_stay_id_idx").on(e.stayId)})),Re=pgTable("availability",{id:uuid("id").defaultRandom().primaryKey(),unitId:uuid("unit_id").references(()=>l.id).notNull(),date:date("date",{mode:"string"}).notNull(),availableCount:integer("available_count").notNull(),priceOverride:integer("price_override"),minNights:integer("min_nights").default(1),status:B("status").default("available")},e=>({unq:uniqueIndex("availability_unit_date_idx").on(e.unitId,e.date)})),T=pgTable("stay_media",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>r.id).notNull(),unitId:uuid("unit_id").references(()=>l.id),url:text("url").notNull(),thumbnailUrl:text("thumbnail_url"),type:C("type").default("image"),caption:text("caption"),sortOrder:integer("sort_order").default(0),isCover:boolean("is_cover").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),ze=pgTable("cancellation_policies",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>r.id).unique(),type:G("type").default("moderate"),freeCancelHours:integer("free_cancel_hours").default(48),refundPercentBefore:integer("refund_percent_before").default(100),refundPercentAfter:integer("refund_percent_after").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Se=pgTable("price_rules",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>r.id).notNull(),unitId:uuid("unit_id").references(()=>l.id),name:text("name").notNull(),type:V("type").notNull(),adjustmentType:$("adjustment_type").notNull(),adjustmentValue:integer("adjustment_value").notNull(),startDate:date("start_date",{mode:"string"}),endDate:date("end_date",{mode:"string"}),daysOfWeek:jsonb("days_of_week"),minNights:integer("min_nights"),isActive:boolean("is_active").default(true),priority:integer("priority").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),qe=relations(r,({many:e})=>({stayUnits:e(l),stayMedia:e(T)})),Ke=relations(l,({one:e})=>({stay:e(r,{fields:[l.stayId],references:[r.id]})})),je=relations(T,({one:e})=>({stay:e(r,{fields:[T.stayId],references:[r.id]})}));var g=pgTable("bookings",{id:uuid("id").defaultRandom().primaryKey(),bookingNumber:text("booking_number").notNull().unique(),stayId:uuid("stay_id").references(()=>r.id).notNull(),unitId:uuid("unit_id").references(()=>l.id).notNull(),customerId:uuid("customer_id").references(()=>i.id).notNull(),ownerId:uuid("owner_id").references(()=>i.id).notNull(),checkIn:date("check_in",{mode:"string"}).notNull(),checkOut:date("check_out",{mode:"string"}).notNull(),nights:integer("nights").notNull(),guestsCount:integer("guests_count").default(1).notNull(),guestName:text("guest_name").notNull(),guestEmail:text("guest_email"),guestPhone:text("guest_phone"),baseAmount:integer("base_amount").notNull(),taxes:integer("taxes").default(0),serviceFee:integer("service_fee").default(0),discount:integer("discount").default(0),totalAmount:integer("total_amount").notNull(),currency:text("currency").default("NPR"),status:M("status").default("initiated").notNull(),paymentStatus:D("payment_status").default("not_required").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}),metadata:jsonb("metadata"),specialRequests:text("special_requests"),cancellationReason:text("cancellation_reason"),cancelledBy:O("cancelled_by"),cancelledAt:timestamp("cancelled_at",{withTimezone:true}),confirmedAt:timestamp("confirmed_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()},e=>({stayIdIdx:index("booking_stay_id_idx").on(e.stayId),customerIdIdx:index("booking_customer_id_idx").on(e.customerId),ownerIdIdx:index("booking_owner_id_idx").on(e.ownerId)})),Pe=pgTable("payments",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>g.id).notNull(),userId:uuid("user_id").references(()=>i.id).notNull(),amount:integer("amount").notNull(),currency:text("currency").default("NPR"),method:F("method").notNull(),gatewayTxnId:text("gateway_txn_id"),gatewayResponse:jsonb("gateway_response"),status:L("status").default("initiated").notNull(),refundAmount:integer("refund_amount").default(0),refundReason:text("refund_reason"),paidAt:timestamp("paid_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var Oe=pgTable("reviews",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>g.id).unique().notNull(),stayId:uuid("stay_id").references(()=>r.id).notNull(),userId:uuid("user_id").references(()=>i.id).notNull(),rating:integer("rating").notNull(),comment:text("comment"),updatedAt:timestamp("updated_at").defaultNow(),createdAt:timestamp("created_at").defaultNow()},e=>({ratingCheck:check("rating_check",sql`${e.rating} >= 1 AND ${e.rating} <= 5`),stayIdIdx:index("review_stay_id_idx").on(e.stayId),userIdIdx:index("review_user_id_idx").on(e.userId)}));var Fe=pgTable("messages",{id:uuid("id").defaultRandom().primaryKey(),conversationId:uuid("conversation_id").notNull(),senderId:uuid("sender_id").references(()=>i.id).notNull(),receiverId:uuid("receiver_id").references(()=>i.id).notNull(),bookingId:uuid("booking_id").references(()=>g.id),content:text("content").notNull(),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({conversationIdIdx:index("message_conversation_id_idx").on(e.conversationId),senderIdIdx:index("message_sender_id_idx").on(e.senderId),receiverIdIdx:index("message_receiver_id_idx").on(e.receiverId),bookingIdIdx:index("message_booking_id_idx").on(e.bookingId)})),Le=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>i.id).notNull(),type:text("type").notNull(),title:text("title").notNull(),body:text("body"),data:jsonb("data").default({}),channel:H("channel").default("in_app"),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),sentAt:timestamp("sent_at",{withTimezone:true}).defaultNow()},e=>({userIdIdx:index("notification_user_id_idx").on(e.userId)})),fe=pgTable("support_tickets",{id:uuid("id").defaultRandom().primaryKey(),ticketNumber:text("ticket_number").notNull().unique(),userId:uuid("user_id").references(()=>i.id).notNull(),bookingId:uuid("booking_id").references(()=>g.id),category:W("category").notNull(),subject:text("subject").notNull(),priority:J("priority").default("medium"),status:Q("status").default("open"),assignedTo:uuid("assigned_to").references(()=>i.id),resolvedAt:timestamp("resolved_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({userIdIdx:index("support_ticket_user_id_idx").on(e.userId),bookingIdIdx:index("support_ticket_booking_id_idx").on(e.bookingId),assignedToIdx:index("support_ticket_assigned_to_idx").on(e.assignedTo)})),Ve=pgTable("support_messages",{id:uuid("id").defaultRandom().primaryKey(),ticketId:uuid("ticket_id").references(()=>fe.id).notNull(),senderId:uuid("sender_id").references(()=>i.id).notNull(),content:text("content").notNull(),attachments:jsonb("attachments").default([]),isInternal:boolean("is_internal").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({ticketIdIdx:index("support_message_ticket_id_idx").on(e.ticketId)}));var We=pgTable("audit_logs",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>i.id),action:text("action").notNull(),entityType:text("entity_type").notNull(),entityId:uuid("entity_id").notNull(),oldValues:jsonb("old_values"),newValues:jsonb("new_values"),ipAddress:inet("ip_address"),userAgent:text("user_agent"),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});Xe.config();var ge=process.env.DATABASE_URL;if(!ge)throw new Error("DATABASE_URL is not set");var z=Qe(ge,{prepare:false,ssl:"require"}),xe=drizzle(z,{schema:oe});var Ze=async()=>{console.log("\u23F3 Running migrations...");let e=Date.now();try{await migrate(xe,{migrationsFolder:"./drizzle"});let w=Date.now();console.log(`\u2705 Migrations completed in ${w-e}ms`),await z.end(),process.exit(0);}catch(w){console.error("\u274C Migration failed"),console.error(w),await z.end(),process.exit(1);}};Ze();