import mt,{Router}from'express';import ns from'cors';import as from'helmet';import is from'cookie-parser';import ht from'dotenv';import {drizzle}from'drizzle-orm/postgres-js';import Ut from'postgres';import {pgEnum,pgTable,timestamp,boolean,text,uuid,integer,jsonb,date,numeric,time,inet}from'drizzle-orm/pg-core';import {eq,desc,and,isNull}from'drizzle-orm';import {z as z$1,ZodError}from'zod';import ut from'bcryptjs';import es from'jsonwebtoken';var gt=Object.defineProperty;var wt=(e,t)=>{for(var s in t)gt(e,s,{get:t[s],enumerable:true});};var a=class extends Error{statusCode;status;isOperational;constructor(t,s){super(t),this.statusCode=s,this.status=`${s}`.startsWith("4")?"fail":"error",this.isOperational=true,Error.captureStackTrace(this,this.constructor);}};ht.config();var ce=(e,t=true)=>{let s=process.env[e];if(t&&!s)throw new Error(`Missing required environment variable: ${e}`);return s||""},$={NODE_ENV:ce("NODE_ENV",false)||"development",PORT:parseInt(ce("PORT",false)||"4000",10),DATABASE_URL:ce("DATABASE_URL",true)};var Ye=(e,t,s,r)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error",$.NODE_ENV==="development"?s.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):e.isOperational?s.status(e.statusCode).json({status:e.status,message:e.message}):(console.error("ERROR \u{1F4A5}",e),s.status(500).json({status:"error",message:"Something went very wrong!"}));};var De={};wt(De,{adjustmentTypeEnum:()=>ve,auditLogs:()=>Pt,availability:()=>It,availabilityStatusEnum:()=>ge,bookingStatusEnum:()=>he,bookings:()=>i,cancellationPolicies:()=>At,cancellationTypeEnum:()=>ke,cancelledByEnum:()=>Ne,customerProfiles:()=>vt,mediaTypeEnum:()=>we,messages:()=>Ct,notificationChannelEnum:()=>Ie,notifications:()=>Bt,ownerProfiles:()=>Rt,paymentMethodEnum:()=>be,paymentStatusEnum:()=>_e,paymentTxnStatusEnum:()=>xe,payments:()=>Tt,payoutStatusEnum:()=>_t,priceRuleTypeEnum:()=>Re,priceRules:()=>Et,reviews:()=>jt,sessions:()=>kt,stayIntentEnum:()=>pe,stayMedia:()=>l,stayStatusEnum:()=>fe,stayTypeEnum:()=>me,stayUnits:()=>z,stays:()=>p,supportMessages:()=>Ot,supportTickets:()=>He,ticketCategoryEnum:()=>Ae,ticketPriorityEnum:()=>Ee,ticketStatusEnum:()=>qe,unitTypeEnum:()=>ye,userRoleEnum:()=>de,users:()=>n,verificationStatusEnum:()=>le});var de=pgEnum("user_role",["customer","owner","admin"]),le=pgEnum("verification_status",["pending","verified","rejected"]),me=pgEnum("stay_type",["hotel","homestay","apartment","room","hostel"]),pe=pgEnum("stay_intent",["short_stay","long_stay","both"]),fe=pgEnum("stay_status",["draft","pending_review","active","suspended","archived"]),ye=pgEnum("unit_type",["private_room","shared_room","entire_place","bed"]),ge=pgEnum("availability_status",["available","blocked","booked"]),we=pgEnum("media_type",["image","video"]),he=pgEnum("booking_status",["pending","confirmed","checked_in","completed","cancelled","no_show"]),_e=pgEnum("payment_status",["unpaid","partial","paid","refunded"]),Ne=pgEnum("cancelled_by",["customer","owner","admin","system"]),be=pgEnum("payment_method",["khalti","esewa","bank_transfer","cash","wallet"]),xe=pgEnum("payment_txn_status",["initiated","pending","completed","failed","refunded"]),Re=pgEnum("price_rule_type",["seasonal","weekend","holiday","long_stay","last_minute"]),ve=pgEnum("adjustment_type",["fixed","percent"]),ke=pgEnum("cancellation_type",["flexible","moderate","strict","non_refundable"]),_t=pgEnum("payout_status",["pending","processing","completed","failed"]),Ie=pgEnum("notification_channel",["in_app","email","sms","push"]),Ae=pgEnum("ticket_category",["booking","payment","property","account","other"]),Ee=pgEnum("ticket_priority",["low","medium","high","urgent"]),qe=pgEnum("ticket_status",["open","in_progress","waiting_customer","resolved","closed"]);var n=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull().unique(),phone:text("phone").unique(),fullName:text("full_name").notNull(),avatarUrl:text("avatar_url"),role:de("role").default("customer").notNull(),password:text("password"),emailVerified:boolean("email_verified").default(false),phoneVerified:boolean("phone_verified").default(false),isActive:boolean("is_active").default(true),lastLoginAt:timestamp("last_login_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),Rt=pgTable("owner_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>n.id).notNull().unique(),businessName:text("business_name"),panNumber:text("pan_number"),citizenshipNumber:text("citizenship_number"),bankName:text("bank_name"),bankAccount:text("bank_account"),address:text("address"),verificationStatus:le("verification_status").default("pending"),totalEarnings:integer("total_earnings").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),vt=pgTable("customer_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>n.id).notNull().unique(),dateOfBirth:date("date_of_birth"),nationality:text("nationality").default("Nepali"),idType:text("id_type"),idNumber:text("id_number"),emergencyContact:text("emergency_contact"),preferences:jsonb("preferences").default({}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),kt=pgTable("sessions",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>n.id).notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}).notNull(),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var p=pgTable("stays",{id:uuid("id").defaultRandom().primaryKey(),ownerId:uuid("owner_id").references(()=>n.id).notNull(),name:text("name").notNull(),slug:text("slug").notNull().unique(),description:text("description"),type:me("type").notNull(),intent:pe("intent").default("both"),status:fe("status").default("draft"),addressLine:text("address_line").notNull(),city:text("city").notNull(),district:text("district").notNull(),province:text("province"),latitude:numeric("latitude",{precision:10,scale:7}),longitude:numeric("longitude",{precision:10,scale:7}),basePrice:integer("base_price").notNull(),maxGuests:integer("max_guests").default(2),amenities:jsonb("amenities").default([]),rules:jsonb("rules").default([]),checkInTime:time("check_in_time").default("14:00:00"),checkOutTime:time("check_out_time").default("11:00:00"),avgRating:numeric("avg_rating",{precision:2,scale:1}).default("0"),totalReviews:integer("total_reviews").default(0),totalBookings:integer("total_bookings").default(0),isFeatured:boolean("is_featured").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),z=pgTable("stay_units",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>p.id).notNull(),name:text("name").notNull(),type:ye("type").notNull(),maxOccupancy:integer("max_occupancy").default(2).notNull(),basePrice:integer("base_price").notNull(),quantity:integer("quantity").default(1),amenities:jsonb("amenities").default([]),isActive:boolean("is_active").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),It=pgTable("availability",{id:uuid("id").defaultRandom().primaryKey(),unitId:uuid("unit_id").references(()=>z.id).notNull(),date:date("date",{mode:"string"}).notNull(),availableCount:integer("available_count").notNull(),priceOverride:integer("price_override"),minNights:integer("min_nights").default(1),status:ge("status").default("available")}),l=pgTable("stay_media",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>p.id).notNull(),unitId:uuid("unit_id").references(()=>z.id),url:text("url").notNull(),thumbnailUrl:text("thumbnail_url"),type:we("type").default("image"),caption:text("caption"),sortOrder:integer("sort_order").default(0),isCover:boolean("is_cover").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),At=pgTable("cancellation_policies",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>p.id).unique(),type:ke("type").default("moderate"),freeCancelHours:integer("free_cancel_hours").default(48),refundPercentBefore:integer("refund_percent_before").default(100),refundPercentAfter:integer("refund_percent_after").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Et=pgTable("price_rules",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>p.id).notNull(),unitId:uuid("unit_id").references(()=>z.id),name:text("name").notNull(),type:Re("type").notNull(),adjustmentType:ve("adjustment_type").notNull(),adjustmentValue:integer("adjustment_value").notNull(),startDate:date("start_date",{mode:"string"}),endDate:date("end_date",{mode:"string"}),daysOfWeek:jsonb("days_of_week"),minNights:integer("min_nights"),isActive:boolean("is_active").default(true),priority:integer("priority").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var i=pgTable("bookings",{id:uuid("id").defaultRandom().primaryKey(),bookingNumber:text("booking_number").notNull().unique(),stayId:uuid("stay_id").references(()=>p.id).notNull(),unitId:uuid("unit_id").references(()=>z.id).notNull(),customerId:uuid("customer_id").references(()=>n.id).notNull(),ownerId:uuid("owner_id").references(()=>n.id).notNull(),checkIn:date("check_in",{mode:"string"}).notNull(),checkOut:date("check_out",{mode:"string"}).notNull(),nights:integer("nights").notNull(),guestsCount:integer("guests_count").default(1).notNull(),guestName:text("guest_name").notNull(),guestEmail:text("guest_email"),guestPhone:text("guest_phone"),baseAmount:integer("base_amount").notNull(),taxes:integer("taxes").default(0),serviceFee:integer("service_fee").default(0),discount:integer("discount").default(0),totalAmount:integer("total_amount").notNull(),currency:text("currency").default("NPR"),status:he("status").default("pending").notNull(),paymentStatus:_e("payment_status").default("unpaid").notNull(),specialRequests:text("special_requests"),cancellationReason:text("cancellation_reason"),cancelledBy:Ne("cancelled_by"),cancelledAt:timestamp("cancelled_at",{withTimezone:true}),confirmedAt:timestamp("confirmed_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),Tt=pgTable("payments",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>i.id).notNull(),userId:uuid("user_id").references(()=>n.id).notNull(),amount:integer("amount").notNull(),currency:text("currency").default("NPR"),method:be("method").notNull(),gatewayTxnId:text("gateway_txn_id"),gatewayResponse:jsonb("gateway_response"),status:xe("status").default("initiated").notNull(),refundAmount:integer("refund_amount").default(0),refundReason:text("refund_reason"),paidAt:timestamp("paid_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),jt=pgTable("reviews",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>i.id).unique().notNull(),stayId:uuid("stay_id").references(()=>p.id).notNull(),reviewerId:uuid("reviewer_id").references(()=>n.id).notNull(),rating:integer("rating").notNull(),cleanliness:integer("cleanliness"),location:integer("location"),value:integer("value"),communication:integer("communication"),comment:text("comment"),ownerReply:text("owner_reply"),ownerRepliedAt:timestamp("owner_replied_at",{withTimezone:true}),isVisible:boolean("is_visible").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var Ct=pgTable("messages",{id:uuid("id").defaultRandom().primaryKey(),conversationId:uuid("conversation_id").notNull(),senderId:uuid("sender_id").references(()=>n.id).notNull(),receiverId:uuid("receiver_id").references(()=>n.id).notNull(),bookingId:uuid("booking_id").references(()=>i.id),content:text("content").notNull(),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Bt=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>n.id).notNull(),type:text("type").notNull(),title:text("title").notNull(),body:text("body"),data:jsonb("data").default({}),channel:Ie("channel").default("in_app"),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),sentAt:timestamp("sent_at",{withTimezone:true}).defaultNow()}),He=pgTable("support_tickets",{id:uuid("id").defaultRandom().primaryKey(),ticketNumber:text("ticket_number").notNull().unique(),userId:uuid("user_id").references(()=>n.id).notNull(),bookingId:uuid("booking_id").references(()=>i.id),category:Ae("category").notNull(),subject:text("subject").notNull(),priority:Ee("priority").default("medium"),status:qe("status").default("open"),assignedTo:uuid("assigned_to").references(()=>n.id),resolvedAt:timestamp("resolved_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Ot=pgTable("support_messages",{id:uuid("id").defaultRandom().primaryKey(),ticketId:uuid("ticket_id").references(()=>He.id).notNull(),senderId:uuid("sender_id").references(()=>n.id).notNull(),content:text("content").notNull(),attachments:jsonb("attachments").default([]),isInternal:boolean("is_internal").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var Pt=pgTable("audit_logs",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>n.id),action:text("action").notNull(),entityType:text("entity_type").notNull(),entityId:uuid("entity_id").notNull(),oldValues:jsonb("old_values"),newValues:jsonb("new_values"),ipAddress:inet("ip_address"),userAgent:text("user_agent"),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});ht.config();var Ge=process.env.DATABASE_URL;if(!Ge)throw new Error("DATABASE_URL is not set");var $t=Ut(Ge,{prepare:false,ssl:"require"}),c=drizzle($t,{schema:De});var ze={async getAll(){return await c.select().from(p)},async getById(e){return (await c.select().from(p).where(eq(p.id,e)))[0]||null}};var d=e=>(t,s,r)=>{e(t,s,r).catch(r);};var Pe={getAllStays:d(async(e,t,s)=>{let r=await ze.getAll();t.status(200).json({status:"success",results:r.length,data:{stays:r}});}),getStay:d(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new a("Stay ID is required",400));let o=await ze.getById(r);if(!o)return s(new a("No stay found with that ID",404));t.status(200).json({status:"success",data:{stay:o}});})};var I=e=>d(async(t,s,r)=>{try{return await e.parseAsync({body:t.body,query:t.query,params:t.params}),r()}catch(o){if(o instanceof ZodError){let u=o.issues.map(k=>`${k.path.join(".")}: ${k.message}`).join(", ");return r(new a(u,400))}return r(o)}});var Qe={createStay:z$1.object({body:z$1.object({name:z$1.string().min(3,"Name must be at least 3 characters"),type:z$1.enum(["hostel","flat","homestay"]),addressLine:z$1.string().min(5,"Address is required"),city:z$1.string().min(2,"City is required"),district:z$1.string().min(2,"District is required"),basePrice:z$1.number().positive("Price must be positive")})}),getStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")})})};var Me=Router();Me.get("/",Pe.getAllStays);Me.get("/:id",I(Qe.getStay),Pe.getStay);var Xe=Me;var V={async getAll(){return await c.select({id:i.id,guestName:i.guestName,guestEmail:i.guestEmail,guestPhone:i.guestPhone,checkIn:i.checkIn,checkOut:i.checkOut,status:i.status,totalAmount:i.totalAmount,createdAt:i.createdAt,stayName:p.name}).from(i).leftJoin(p,eq(i.stayId,p.id)).orderBy(desc(i.createdAt))},async getById(e){return (await c.select({id:i.id,guestName:i.guestName,guestEmail:i.guestEmail,guestPhone:i.guestPhone,checkIn:i.checkIn,checkOut:i.checkOut,status:i.status,totalAmount:i.totalAmount,createdAt:i.createdAt,stayName:p.name,specialRequests:i.id}).from(i).leftJoin(p,eq(i.stayId,p.id)).where(eq(i.id,e)))[0]||null},async create(e){return (await c.insert(i).values(e).returning())[0]},async updateStatus(e,t){return (await c.update(i).set({status:t}).where(eq(i.id,e)).returning())[0]}};var Y={getAllBookings:d(async(e,t,s)=>{let r=await V.getAll();t.status(200).json({status:"success",results:r.length,data:{bookings:r}});}),getBooking:d(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new a("Booking ID is required",400));let o=await V.getById(r);if(!o)return s(new a("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:o}});}),createBooking:d(async(e,t,s)=>{let r=await V.create(e.body);t.status(201).json({status:"success",data:{booking:r}});}),updateBookingStatus:d(async(e,t,s)=>{let{id:r}=e.params,{status:o}=e.body;if(!o)return s(new a("Status is required",400));let u=await V.updateStatus(r,o);if(!u)return s(new a("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:u}});})};var re={createBooking:z$1.object({body:z$1.object({stayId:z$1.string().uuid("Invalid Stay ID"),unitId:z$1.string().uuid("Invalid Unit ID"),checkIn:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-in date format (YYYY-MM-DD)"),checkOut:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-out date format (YYYY-MM-DD)"),totalAmount:z$1.number().positive("Total amount must be positive")})}),updateStatus:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Booking ID")}),body:z$1.object({status:z$1.string().min(1,"Status is required")})})};var L=Router();L.get("/",Y.getAllBookings);L.get("/:id",I(re.updateStatus),Y.getBooking);L.post("/",I(re.createBooking),Y.createBooking);L.patch("/:id/status",I(re.updateStatus),Y.updateBookingStatus);var et=L;var J={async getAll(){return await c.select().from(n).where(eq(n.role,"owner"))},async getById(e){return (await c.select().from(n).where(and(eq(n.id,e),eq(n.role,"owner"))))[0]||null},async create(e){let t={...e,role:"owner"};return (await c.insert(n).values(t).returning())[0]},async getByEmail(e){return (await c.select().from(n).where(and(eq(n.email,e),eq(n.role,"owner"))))[0]||null}};var oe={getAllOwners:d(async(e,t,s)=>{let r=await J.getAll();t.status(200).json({status:"success",results:r.length,data:{owners:r}});}),getOwner:d(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new a("Owner ID is required",400));let o=await J.getById(r);if(!o)return s(new a("No owner found with that ID",404));t.status(200).json({status:"success",data:{owner:o}});}),createOwner:d(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new a("Email is required",400));if(await J.getByEmail(r))return s(new a("Owner with this email already exists",400));let u=await J.create(e.body);t.status(201).json({status:"success",data:{owner:u}});})};var ne=Router();ne.get("/",oe.getAllOwners);ne.get("/:id",oe.getOwner);ne.post("/",oe.createOwner);var st=ne;var Z={async getAll(){return await c.select().from(n).where(eq(n.role,"customer"))},async getById(e){return (await c.select().from(n).where(and(eq(n.id,e),eq(n.role,"customer"))))[0]||null},async create(e){let t={...e,role:"customer"};return (await c.insert(n).values(t).returning())[0]},async getByEmail(e){return (await c.select().from(n).where(and(eq(n.email,e),eq(n.role,"customer"))))[0]||null}};var ae={getAllCustomers:d(async(e,t,s)=>{let r=await Z.getAll();t.status(200).json({status:"success",results:r.length,data:{customers:r}});}),getCustomer:d(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new a("Customer ID is required",400));let o=await Z.getById(r);if(!o)return s(new a("No customer found with that ID",404));t.status(200).json({status:"success",data:{customer:o}});}),createCustomer:d(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new a("Email is required",400));if(await Z.getByEmail(r))return s(new a("Customer with this email already exists",400));let u=await Z.create(e.body);t.status(201).json({status:"success",data:{customer:u}});})};var ie=Router();ie.get("/",ae.getAllCustomers);ie.get("/:id",ae.getCustomer);ie.post("/",ae.createCustomer);var ot=ie;var Ue={getProfile:async(e,t,s)=>{try{let r={id:"user_123",email:"user@example.com",role:"customer",createdAt:new Date};return t.status(200).json({status:"success",data:{user:r}})}catch(r){s(r);}},listUsers:async(e,t,s)=>{try{return t.status(200).json({status:"success",data:{users:[]}})}catch(r){s(r);}}};var Ke=Router();Ke.get("/profile",Ue.getProfile);Ke.get("/",Ue.listUsers);var nt=Ke;var P={async addMedia(e){return (await c.insert(l).values(e).returning())[0]},async getMediaByStay(e,t=false){let s=t?and(eq(l.stayId,e),isNull(l.unitId)):eq(l.stayId,e);return await c.select().from(l).where(s).orderBy(l.sortOrder)},async getMediaByUnit(e){return await c.select().from(l).where(eq(l.unitId,e)).orderBy(l.sortOrder)},async deleteMedia(e){return (await c.delete(l).where(eq(l.id,e)).returning())[0]},async setCover(e,t,s){return await c.transaction(async r=>{let o=s?and(eq(l.stayId,t),eq(l.unitId,s)):and(eq(l.stayId,t),isNull(l.unitId));return await r.update(l).set({isCover:false}).where(o),(await r.update(l).set({isCover:true}).where(eq(l.id,e)).returning())[0]})},async updateMedia(e,t){return (await c.update(l).set({...t}).where(eq(l.id,e)).returning())[0]}};var M={uploadMedia:d(async(e,t,s)=>{let{stayId:r,unitId:o,url:u,type:k,caption:K,isCover:ft}=e.body;if(!r||!u)return s(new a("Stay ID and URL are required",400));let yt=await P.addMedia({stayId:r,unitId:o||null,url:u,type:k||"image",caption:K,isCover:ft||false});t.status(201).json({status:"success",data:{media:yt}});}),getStayMedia:d(async(e,t,s)=>{let{stayId:r}=e.params,{propertyOnly:o}=e.query;if(!r)return s(new a("Stay ID is required",400));let u=await P.getMediaByStay(r,o==="true");t.status(200).json({status:"success",results:u.length,data:{media:u}});}),getUnitMedia:d(async(e,t,s)=>{let{unitId:r}=e.params;if(!r)return s(new a("Unit ID is required",400));let o=await P.getMediaByUnit(r);t.status(200).json({status:"success",results:o.length,data:{media:o}});}),setCover:d(async(e,t,s)=>{let{id:r}=e.params,{stayId:o,unitId:u}=e.body;if(!o)return s(new a("Stay ID is required in body",400));let k=await P.setCover(r,o,u);t.status(200).json({status:"success",data:{media:k}});}),removeMedia:d(async(e,t,s)=>{let{id:r}=e.params;if(!await P.deleteMedia(r))return s(new a("No media found with that ID",404));t.status(204).json({status:"success",data:null});})};var U=Router();U.post("/",M.uploadMedia);U.delete("/:id",M.removeMedia);U.patch("/:id/cover",M.setCover);U.get("/stays/:stayId",M.getStayMedia);U.get("/units/:unitId",M.getUnitMedia);var it=U;var ue={generateToken(e){let t=process.env.JWT_SECRET||"fallback_secret";return es.sign({id:e},t,{expiresIn:process.env.JWT_EXPIRES_IN||"30d"})},async comparePasswords(e,t){return await ut.compare(e,t)},async login(e,t){let s=await c.query.users.findFirst({where:eq(n.email,e)});if(!s||!s.password||!await this.comparePasswords(t,s.password))return null;let{password:o,...u}=s;return u},async signup(e){let t=await ut.hash(e.password,12),r=(await c.insert(n).values({...e,password:t}).returning())[0],{password:o,...u}=r;return u}};var O={sendTokenCookie(e,t,s){let r=ue.generateToken(e.id),o={expires:new Date(Date.now()+720*60*60*1e3),httpOnly:true,secure:process.env.NODE_ENV==="production",sameSite:process.env.NODE_ENV==="production"?"none":"lax"};s.cookie("jwt",r,o),s.status(t).json({status:"success",token:r,data:{user:e}});},signup:d(async(e,t,s)=>{let{email:r,password:o,fullName:u,role:k}=e.body;if(!r||!o||!u)return s(new a("Please provide email, password and full name",400));let K=await ue.signup({email:r,password:o,fullName:u,role:k||"customer"});O.sendTokenCookie(K,201,t);}),login:d(async(e,t,s)=>{let{email:r,password:o}=e.body;if(!r||!o)return s(new a("Please provide email and password",400));let u=await ue.login(r,o);if(!u)return s(new a("Incorrect email or password",401));O.sendTokenCookie(u,200,t);}),logout:(e,t)=>{t.cookie("jwt","loggedout",{expires:new Date(Date.now()+10*1e3),httpOnly:true}),t.status(200).json({status:"success"});},getMe:(e,t)=>{t.status(200).json({status:"success",data:{user:e.user}});}};var ct=d(async(e,t,s)=>{let r;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?r=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(r=e.cookies.jwt),!r)return s(new a("You are not logged in! Please log in to get access.",401));let o=es.verify(r,process.env.JWT_SECRET||"fallback_secret"),u=await c.query.users.findFirst({where:eq(n.id,o.id)});if(!u)return s(new a("The user belonging to this token no longer exists.",401));let{password:k,...K}=u;e.user=K,s();});var Ve={signup:z$1.object({body:z$1.object({fullName:z$1.string().min(2,"Full name must be at least 2 characters"),email:z$1.string().email("Invalid email address"),password:z$1.string().min(8,"Password must be at least 8 characters"),role:z$1.enum(["customer","owner","admin"]).optional()})}),login:z$1.object({body:z$1.object({email:z$1.string().email("Invalid email address"),password:z$1.string().min(1,"Password is required")})})};var G=Router();G.post("/signup",I(Ve.signup),O.signup);G.post("/login",I(Ve.login),O.login);G.get("/logout",O.logout);G.get("/me",ct,O.getMe);var dt=G;var S=Router();S.use("/auth",dt);S.use("/stays",Xe);S.use("/bookings",et);S.use("/owners",st);S.use("/customers",ot);S.use("/users",nt);S.use("/media",it);var lt=S;var E=mt();E.use(as());E.use(ns({origin:"http://localhost:3000",credentials:true}));E.use(mt.json());E.use(is());E.get("/health",(e,t)=>{t.status(200).json({status:"success",message:"StaySewa API is healthy"});});E.use("/api",lt);E.use((e,t,s)=>{s(new a(`Can't find ${e.originalUrl} on this server!`,404));});E.use(Ye);var pt=E;var us=async()=>{try{let e=$.PORT||8e3;pt.listen(e,()=>{console.log(`\u{1F680} Production-ready server running at http://localhost:${e}`),console.log(`\u{1F4E1} Environment: ${$.NODE_ENV}`);});}catch(e){console.error("\u274C Failed to start server:",e),process.exit(1);}};us();//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map