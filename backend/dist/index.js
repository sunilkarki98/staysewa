import Tt,{Router}from'express';import Rs from'dotenv';import qr from'cors';import Or from'helmet';import Cr from'cookie-parser';import vs from'pino';import {drizzle}from'drizzle-orm/postgres-js';import Xs from'postgres';import {pgEnum,pgTable,timestamp,boolean,text,uuid,integer,jsonb,date,numeric,time,index,uniqueIndex,check,inet}from'drizzle-orm/pg-core';import {relations,sql,and,eq,lt,gte,lte,desc,gt,ne,count,isNull,or as or$1,ilike}from'drizzle-orm';import or from'slugify';import {v4}from'uuid';import ir from'ioredis';import {z as z$1,ZodError}from'zod';import ur from'jsonwebtoken';import is from'multer';import hr from'path';import cs from'bcryptjs';import ms from'axios';import {rateLimit}from'express-rate-limit';import Ur from'node-cron';var ks=Object.defineProperty;var Is=(e,t)=>{for(var s in t)ks(e,s,{get:t[s],enumerable:true});};Rs.config();var P=(e,t=true)=>{let s=process.env[e];if(t&&!s)throw new Error(`Missing required environment variable: ${e}`);return s||""},f={NODE_ENV:P("NODE_ENV",false)||"development",PORT:parseInt(P("PORT",false)||"4000",10),DATABASE_URL:P("DATABASE_URL",true),JWT_SECRET:P("JWT_SECRET",true),JWT_EXPIRES_IN:P("JWT_EXPIRES_IN",false)||"30d",CORS_ORIGIN:P("CORS_ORIGIN",false)||"http://localhost:3000",KHALTI_SECRET_KEY:P("KHALTI_SECRET_KEY",false)||"mock_secret_key",KHALTI_BASE_URL:P("KHALTI_BASE_URL",false)||"https://a.khalti.com/api/v2",REDIS_URL:P("REDIS_URL",false),JWT_COOKIE_EXPIRES_IN:P("JWT_COOKIE_EXPIRES_IN",false)||"30",SUPABASE_JWT_SECRET:P("SUPABASE_JWT_SECRET",false)};var g=vs({level:f.NODE_ENV==="development"?"debug":"info",transport:f.NODE_ENV==="development"?{target:"pino-pretty",options:{colorize:true,translateTime:"HH:MM:ss Z",ignore:"pid,hostname"}}:void 0});var qt=(e,t,s,r)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error",f.NODE_ENV==="development"?s.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):e.isOperational?s.status(e.statusCode).json({status:e.status,message:e.message}):(g.error(e,"ERROR \u{1F4A5}"),s.status(500).json({status:"error",message:"Something went very wrong!"}));};var c=class extends Error{statusCode;status;isOperational;constructor(t,s){super(t),this.statusCode=s,this.status=`${s}`.startsWith("4")?"fail":"error",this.isOperational=true,Error.captureStackTrace(this,this.constructor);}};var wt={};Is(wt,{adjustmentTypeEnum:()=>rt,auditLogs:()=>Hs,availability:()=>Os,availabilityStatusEnum:()=>He,bookingStatusEnum:()=>Xe,bookings:()=>o,cancellationPolicies:()=>Cs,cancellationTypeEnum:()=>ot,cancelledByEnum:()=>Qe,customerProfiles:()=>Es,idTypeEnum:()=>Ne,mediaTypeEnum:()=>Ge,messages:()=>zs,notificationChannelEnum:()=>nt,notifications:()=>Ls,ownerProfiles:()=>j,paymentMethodEnum:()=>et,paymentStatusEnum:()=>Ze,paymentTxnStatusEnum:()=>tt,payments:()=>R,payoutStatusEnum:()=>xs,priceRuleTypeEnum:()=>st,priceRules:()=>Bs,reviews:()=>z,sessions:()=>Ts,stayIntentEnum:()=>Je,stayMedia:()=>y,stayMediaRelations:()=>Fs,stayStatusEnum:()=>Ve,stayTypeEnum:()=>We,stayUnits:()=>E,stayUnitsRelations:()=>js,stays:()=>d,staysRelations:()=>Ps,supportMessages:()=>Ws,supportTickets:()=>Mt,ticketCategoryEnum:()=>it,ticketPriorityEnum:()=>at,ticketStatusEnum:()=>ut,unitTypeEnum:()=>Ye,userRoleEnum:()=>ze,users:()=>u,verificationStatusEnum:()=>Le});var ze=pgEnum("user_role",["customer","owner","admin"]),Le=pgEnum("verification_status",["pending","verified","rejected"]),Ne=pgEnum("id_type",["citizenship","national_id_card","passport","national_id"]),We=pgEnum("stay_type",["hotel","homestay","apartment","room","hostel"]),Je=pgEnum("stay_intent",["short_stay","long_stay","both"]),Ve=pgEnum("stay_status",["draft","pending_review","active","suspended","archived"]),Ye=pgEnum("unit_type",["private_room","shared_room","entire_place","bed"]),He=pgEnum("availability_status",["available","blocked","booked"]),Ge=pgEnum("media_type",["image","video"]),Xe=pgEnum("booking_status",["initiated","reserved","confirmed","checked_in","completed","cancelled","expired","no_show","pending"]),Ze=pgEnum("payment_status",["not_required","pending","success","failed","refunded","unpaid","paid"]),Qe=pgEnum("cancelled_by",["customer","owner","admin","system"]),et=pgEnum("payment_method",["khalti","esewa","bank_transfer","cash","wallet"]),tt=pgEnum("payment_txn_status",["initiated","pending","completed","failed","refunded"]),st=pgEnum("price_rule_type",["seasonal","weekend","holiday","long_stay","last_minute"]),rt=pgEnum("adjustment_type",["fixed","percent"]),ot=pgEnum("cancellation_type",["flexible","moderate","strict","non_refundable"]),xs=pgEnum("payout_status",["pending","processing","completed","failed"]),nt=pgEnum("notification_channel",["in_app","email","sms","push"]),it=pgEnum("ticket_category",["booking","payment","property","account","other"]),at=pgEnum("ticket_priority",["low","medium","high","urgent"]),ut=pgEnum("ticket_status",["open","in_progress","waiting_customer","resolved","closed"]);var u=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull().unique(),phone:text("phone").unique(),fullName:text("full_name").notNull(),avatarUrl:text("avatar_url"),role:ze("role").default("customer").notNull(),password:text("password"),emailVerified:boolean("email_verified").default(false),phoneVerified:boolean("phone_verified").default(false),isActive:boolean("is_active").default(true),lastLoginAt:timestamp("last_login_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),j=pgTable("owner_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),nationality:text("nationality").default("Nepali"),businessName:text("business_name"),panNumber:text("pan_number"),idType:Ne("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),bankName:text("bank_name"),bankAccount:text("bank_account"),address:text("address"),verificationStatus:Le("verification_status").default("pending"),totalEarnings:integer("total_earnings").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Es=pgTable("customer_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),dateOfBirth:date("date_of_birth"),nationality:text("nationality").default("Nepali"),idType:Ne("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),emergencyContact:text("emergency_contact"),preferences:jsonb("preferences").default({}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Ts=pgTable("sessions",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}).notNull(),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var d=pgTable("stays",{id:uuid("id").defaultRandom().primaryKey(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),name:text("name").notNull(),slug:text("slug").notNull().unique(),description:text("description"),type:We("type").notNull(),intent:Je("intent").default("both"),status:Ve("status").default("draft"),addressLine:text("address_line").notNull(),city:text("city").notNull(),district:text("district").notNull(),province:text("province"),latitude:numeric("latitude",{precision:10,scale:7}),longitude:numeric("longitude",{precision:10,scale:7}),basePrice:integer("base_price").notNull(),maxGuests:integer("max_guests").default(2),amenities:jsonb("amenities").default([]),rules:jsonb("rules").default([]),checkInTime:time("check_in_time").default("14:00:00"),checkOutTime:time("check_out_time").default("11:00:00"),avgRating:numeric("avg_rating",{precision:2,scale:1}).default("0"),totalReviews:integer("total_reviews").default(0),totalBookings:integer("total_bookings").default(0),isFeatured:boolean("is_featured").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()},e=>({ownerIdIdx:index("stay_owner_id_idx").on(e.ownerId)})),E=pgTable("stay_units",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),name:text("name").notNull(),type:Ye("type").notNull(),maxOccupancy:integer("max_occupancy").default(2).notNull(),basePrice:integer("base_price").notNull(),quantity:integer("quantity").default(1),amenities:jsonb("amenities").default([]),isActive:boolean("is_active").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({stayIdIdx:index("stay_unit_stay_id_idx").on(e.stayId)})),Os=pgTable("availability",{id:uuid("id").defaultRandom().primaryKey(),unitId:uuid("unit_id").references(()=>E.id).notNull(),date:date("date",{mode:"string"}).notNull(),availableCount:integer("available_count").notNull(),priceOverride:integer("price_override"),minNights:integer("min_nights").default(1),status:He("status").default("available")},e=>({unq:uniqueIndex("availability_unit_date_idx").on(e.unitId,e.date)})),y=pgTable("stay_media",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>E.id),url:text("url").notNull(),thumbnailUrl:text("thumbnail_url"),type:Ge("type").default("image"),caption:text("caption"),sortOrder:integer("sort_order").default(0),isCover:boolean("is_cover").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Cs=pgTable("cancellation_policies",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).unique(),type:ot("type").default("moderate"),freeCancelHours:integer("free_cancel_hours").default(48),refundPercentBefore:integer("refund_percent_before").default(100),refundPercentAfter:integer("refund_percent_after").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Bs=pgTable("price_rules",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>E.id),name:text("name").notNull(),type:st("type").notNull(),adjustmentType:rt("adjustment_type").notNull(),adjustmentValue:integer("adjustment_value").notNull(),startDate:date("start_date",{mode:"string"}),endDate:date("end_date",{mode:"string"}),daysOfWeek:jsonb("days_of_week"),minNights:integer("min_nights"),isActive:boolean("is_active").default(true),priority:integer("priority").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Ps=relations(d,({many:e})=>({stayUnits:e(E),stayMedia:e(y)})),js=relations(E,({one:e})=>({stay:e(d,{fields:[E.stayId],references:[d.id]})})),Fs=relations(y,({one:e})=>({stay:e(d,{fields:[y.stayId],references:[d.id]})}));var o=pgTable("bookings",{id:uuid("id").defaultRandom().primaryKey(),bookingNumber:text("booking_number").notNull().unique(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>E.id).notNull(),customerId:uuid("customer_id").references(()=>u.id).notNull(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),checkIn:date("check_in",{mode:"string"}).notNull(),checkOut:date("check_out",{mode:"string"}).notNull(),nights:integer("nights").notNull(),guestsCount:integer("guests_count").default(1).notNull(),guestName:text("guest_name").notNull(),guestEmail:text("guest_email"),guestPhone:text("guest_phone"),baseAmount:integer("base_amount").notNull(),taxes:integer("taxes").default(0),serviceFee:integer("service_fee").default(0),discount:integer("discount").default(0),totalAmount:integer("total_amount").notNull(),currency:text("currency").default("NPR"),status:Xe("status").default("initiated").notNull(),paymentStatus:Ze("payment_status").default("not_required").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}),metadata:jsonb("metadata"),specialRequests:text("special_requests"),cancellationReason:text("cancellation_reason"),cancelledBy:Qe("cancelled_by"),cancelledAt:timestamp("cancelled_at",{withTimezone:true}),confirmedAt:timestamp("confirmed_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()},e=>({stayIdIdx:index("booking_stay_id_idx").on(e.stayId),customerIdIdx:index("booking_customer_id_idx").on(e.customerId),ownerIdIdx:index("booking_owner_id_idx").on(e.ownerId)})),R=pgTable("payments",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>o.id).notNull(),userId:uuid("user_id").references(()=>u.id).notNull(),amount:integer("amount").notNull(),currency:text("currency").default("NPR"),method:et("method").notNull(),gatewayTxnId:text("gateway_txn_id"),gatewayResponse:jsonb("gateway_response"),status:tt("status").default("initiated").notNull(),refundAmount:integer("refund_amount").default(0),refundReason:text("refund_reason"),paidAt:timestamp("paid_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var z=pgTable("reviews",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>o.id).unique().notNull(),stayId:uuid("stay_id").references(()=>d.id).notNull(),userId:uuid("user_id").references(()=>u.id).notNull(),rating:integer("rating").notNull(),comment:text("comment"),updatedAt:timestamp("updated_at").defaultNow(),createdAt:timestamp("created_at").defaultNow()},e=>({ratingCheck:check("rating_check",sql`${e.rating} >= 1 AND ${e.rating} <= 5`),stayIdIdx:index("review_stay_id_idx").on(e.stayId),userIdIdx:index("review_user_id_idx").on(e.userId)}));var zs=pgTable("messages",{id:uuid("id").defaultRandom().primaryKey(),conversationId:uuid("conversation_id").notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),receiverId:uuid("receiver_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>o.id),content:text("content").notNull(),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({conversationIdIdx:index("message_conversation_id_idx").on(e.conversationId),senderIdIdx:index("message_sender_id_idx").on(e.senderId),receiverIdIdx:index("message_receiver_id_idx").on(e.receiverId),bookingIdIdx:index("message_booking_id_idx").on(e.bookingId)})),Ls=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),type:text("type").notNull(),title:text("title").notNull(),body:text("body"),data:jsonb("data").default({}),channel:nt("channel").default("in_app"),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),sentAt:timestamp("sent_at",{withTimezone:true}).defaultNow()},e=>({userIdIdx:index("notification_user_id_idx").on(e.userId)})),Mt=pgTable("support_tickets",{id:uuid("id").defaultRandom().primaryKey(),ticketNumber:text("ticket_number").notNull().unique(),userId:uuid("user_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>o.id),category:it("category").notNull(),subject:text("subject").notNull(),priority:at("priority").default("medium"),status:ut("status").default("open"),assignedTo:uuid("assigned_to").references(()=>u.id),resolvedAt:timestamp("resolved_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({userIdIdx:index("support_ticket_user_id_idx").on(e.userId),bookingIdIdx:index("support_ticket_booking_id_idx").on(e.bookingId),assignedToIdx:index("support_ticket_assigned_to_idx").on(e.assignedTo)})),Ws=pgTable("support_messages",{id:uuid("id").defaultRandom().primaryKey(),ticketId:uuid("ticket_id").references(()=>Mt.id).notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),content:text("content").notNull(),attachments:jsonb("attachments").default([]),isInternal:boolean("is_internal").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()},e=>({ticketIdIdx:index("support_message_ticket_id_idx").on(e.ticketId)}));var Hs=pgTable("audit_logs",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id),action:text("action").notNull(),entityType:text("entity_type").notNull(),entityId:uuid("entity_id").notNull(),oldValues:jsonb("old_values"),newValues:jsonb("new_values"),ipAddress:inet("ip_address"),userAgent:text("user_agent"),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});Rs.config();var Kt=process.env.DATABASE_URL;if(!Kt)throw new Error("DATABASE_URL is not set");var Qs=Xs(Kt,{prepare:false,ssl:"require"}),a=drizzle(Qs,{schema:wt});var me={async search(e){let{location:t,minPrice:s,maxPrice:r,type:n,guests:i}=e,p=[];return t&&t!=="all"&&p.push(sql`lower(${d.city}) LIKE ${`%${t.toLowerCase()}%`} OR lower(${d.addressLine}) LIKE ${`%${t.toLowerCase()}%`} OR lower(${d.district}) LIKE ${`%${t.toLowerCase()}%`}`),n&&n!=="all"&&p.push(eq(d.type,n)),s&&p.push(gte(d.basePrice,s)),r&&p.push(lte(d.basePrice,r)),i&&p.push(gte(d.maxGuests,i)),await a.query.stays.findMany({where:and(...p),with:{stayMedia:true,stayUnits:true},orderBy:desc(d.createdAt)})},async getAll(){return this.search({})},async getById(e){return await a.query.stays.findFirst({where:eq(d.id,e),with:{stayUnits:true,stayMedia:true}})||null},async create(e){return await a.transaction(async t=>{let r=`${or(e.name,{lower:true,strict:true})}-${v4().slice(0,8)}`,{stayUnits:n,images:i,...p}=e,[w]=await t.insert(d).values({...p,slug:r}).returning();if(n&&n.length>0){let B=n.map(D=>({...D,stayId:w.id}));await t.insert(E).values(B);}if(i&&i.length>0){let B=i.map((D,ge)=>({stayId:w.id,url:D,type:"image",sortOrder:ge,isCover:ge===0}));await t.insert(y).values(B);}return w})},async update(e,t){return (await a.update(d).set({...t,updatedAt:new Date}).where(eq(d.id,e)).returning())[0]},async delete(e){return (await a.delete(d).where(eq(d.id,e)).returning())[0]}};var m=e=>(t,s,r)=>{e(t,s,r).catch(r);};var Lt=f.REDIS_URL,b=null;Lt?(b=new ir(Lt,{maxRetriesPerRequest:3,retryStrategy(e){return Math.min(e*50,2e3)}}),b.on("connect",()=>{g.info("Redis connected successfully");}),b.on("error",e=>{g.error(e,"Redis connection error");})):g.warn("REDIS_URL not provided, caching will be disabled");var le={getAllStays:m(async(e,t,s)=>{let r="stays:all";if(b){let p=await b.get(r);if(p){let w=JSON.parse(p);return t.status(200).json({status:"success",results:w.length,data:{stays:w}})}}let n={location:e.query.location,minPrice:e.query.minPrice?Number(e.query.minPrice):void 0,maxPrice:e.query.maxPrice?Number(e.query.maxPrice):void 0,type:e.query.category,guests:e.query.guests?Number(e.query.guests):void 0,checkIn:e.query.checkIn,checkOut:e.query.checkOut},i=await me.search(n);b&&await b.set(r,JSON.stringify(i),"EX",300),t.status(200).json({status:"success",results:i.length,data:{stays:i}});}),getStay:m(async(e,t,s)=>{let{id:r}=e.params,n=await me.getById(r);if(!n)return s(new c("No stay found with that ID",404));t.status(200).json({status:"success",data:{stay:n}});}),createStay:m(async(e,t,s)=>{let r=e.user?.id,n=await me.create({...e.body,ownerId:r||e.body.ownerId});b&&await b.del("stays:all"),t.status(201).json({status:"success",data:{stay:n}});}),updateStay:m(async(e,t,s)=>{let{id:r}=e.params,n=await me.update(r,e.body);if(!n)return s(new c("No stay found with that ID",404));b&&await b.del("stays:all"),t.status(200).json({status:"success",data:{stay:n}});}),deleteStay:m(async(e,t,s)=>{let{id:r}=e.params;if(!await me.delete(r))return s(new c("No stay found with that ID",404));b&&await b.del("stays:all"),t.status(204).json({status:"success",data:null});})};var v=e=>m(async(t,s,r)=>{try{return await e.parseAsync({body:t.body,query:t.query,params:t.params}),r()}catch(n){if(n instanceof ZodError){let i=n.issues.map(p=>`${p.path.join(".")}: ${p.message}`).join(", ");return r(new c(i,400))}return r(n)}});var k=m(async(e,t,s)=>{let r;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?r=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(r=e.cookies.jwt),!r)return s(new c("You are not logged in! Please log in to get access.",401));if(!f.SUPABASE_JWT_SECRET)return s(new c("Server misconfiguration: Missing SUPABASE_JWT_SECRET",500));try{let n=ur.verify(r,f.SUPABASE_JWT_SECRET),i=n.sub,p=await a.query.users.findFirst({where:eq(u.id,i)});if(!p){let w=n.email||(n.phone?`${n.phone}@phone.staysewa.com`:`no-email-${i}@staysewa.com`);try{p=(await a.insert(u).values({id:i,email:w,fullName:n.user_metadata?.full_name||"StaySewa User",role:n.user_metadata?.role||n.app_metadata?.role||"customer",emailVerified:!!n.email,password:null}).returning())[0];}catch{p=await a.query.users.findFirst({where:eq(u.id,i)});}}if(!p)return s(new c("User could not be synced",500));e.user=p,s();}catch(n){return console.error("JWT Verification Failed:",n),s(new c("Invalid token",401))}}),S=(...e)=>(t,s,r)=>{if(!t.user||!e.includes(t.user.role))return r(new c("You do not have permission to perform this action",403));r();};var we={createStay:z$1.object({body:z$1.object({name:z$1.string().min(3,"Name must be at least 3 characters"),type:z$1.enum(["hotel","homestay","apartment","room","hostel"]),intent:z$1.enum(["short_stay","long_stay","both"]).default("both"),addressLine:z$1.string().min(3,"Address is required"),city:z$1.string().min(2,"City is required"),district:z$1.string().min(2,"District is required"),province:z$1.string().optional(),basePrice:z$1.number().positive("Price must be positive"),maxGuests:z$1.number().int().positive().default(1),amenities:z$1.array(z$1.string()).default([]),rules:z$1.array(z$1.string()).default([]),description:z$1.string().optional(),checkInTime:z$1.string().optional(),checkOutTime:z$1.string().optional(),stayUnits:z$1.array(z$1.object({name:z$1.string().min(1),type:z$1.enum(["room","bed","private_room","entire_place","shared_room"]),maxOccupancy:z$1.number().positive(),basePrice:z$1.number().positive(),quantity:z$1.number().int().positive().default(1),amenities:z$1.array(z$1.string()).default([])})).optional()})}),getStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")})}),updateStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")}),body:z$1.object({name:z$1.string().min(3).optional(),type:z$1.enum(["hotel","homestay","apartment","room","hostel"]).optional(),basePrice:z$1.number().positive().optional(),addressLine:z$1.string().optional(),city:z$1.string().optional(),district:z$1.string().optional(),amenities:z$1.array(z$1.string()).optional(),rules:z$1.array(z$1.string()).optional()})}),deleteStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")})})};var Ce={async create(e){let t=await a.query.bookings.findFirst({where:and(eq(o.id,e.bookingId),eq(o.customerId,e.userId))});if(!t)throw new c("Booking not found or access denied",404);if(await a.query.reviews.findFirst({where:eq(z.bookingId,e.bookingId)}))throw new c("You have already reviewed this stay",400);let[r]=await a.insert(z).values({bookingId:e.bookingId,stayId:t.stayId,userId:e.userId,rating:e.rating,comment:e.comment}).returning();return r},async getByStay(e){return await a.query.reviews.findMany({where:eq(z.stayId,e),orderBy:[desc(z.createdAt)],with:{user:{columns:{name:true}}}})},async getStats(e){return (await a.select({averageRating:sql`avg(${z.rating})::numeric(10,1)`,count:sql`count(*)`}).from(z).where(eq(z.stayId,e)))[0]||{averageRating:"0",count:0}}};var ht={createReview:m(async(e,t,s)=>{let{bookingId:r,rating:n,comment:i}=e.body,p=e.user?.id;if(!p)return t.status(401).json({status:"fail",message:"Unauthorized"});let w=await Ce.create({bookingId:r,rating:n,comment:i,userId:p});t.status(201).json({status:"success",data:{review:w}});}),getStayReviews:m(async(e,t,s)=>{let{stayId:r}=e.params,n=Array.isArray(r)?r[0]:r,i=await Ce.getByStay(n),p=await Ce.getStats(n);t.status(200).json({status:"success",data:{reviews:i,stats:p}});})};var Be=Router({mergeParams:true});Be.use(k);Be.route("/").post(S("user"),ht.createReview);var _t=Router({mergeParams:true});_t.route("/stay/:stayId").get(ht.getStayReviews);var Y=Router();Y.use("/:stayId/reviews",_t);Y.get("/",le.getAllStays);Y.get("/:id",v(we.getStay),le.getStay);Y.use(k);Y.post("/",S("owner","admin"),v(we.createStay),le.createStay);Y.patch("/:id",S("owner","admin"),v(we.updateStay),le.updateStay);Y.delete("/:id",S("owner","admin"),v(we.deleteStay),le.deleteStay);var Yt=Y;var bt={async acquireLock(e,t=5e3){if(!b)return g.warn("Redis not configured, skipping lock acquisition (unsafe for production concurrency)"),"mock-token";let s=Math.random().toString(36).substring(2)+Date.now().toString(36);try{return await b.set(e,s,"PX",t,"NX")==="OK"?s:null}catch(r){return g.error(r,`Failed to acquire lock for key ${e}`),null}},async releaseLock(e,t){if(!(!b||t==="mock-token"))try{await b.eval(`
                if redis.call("get", KEYS[1]) == ARGV[1] then
                    return redis.call("del", KEYS[1])
                else
                    return 0
                end
            `,1,e,t);}catch(s){g.error(s,`Failed to release lock for key ${e}`);}}};var te={async findOverlap(e,t,s){return await a.query.bookings.findFirst({where:and(eq(o.unitId,e),ne(o.status,"cancelled"),lt(o.checkIn,s),gt(o.checkOut,t))})},async getAll(){return await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).orderBy(desc(o.createdAt))},async getById(e){return (await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name,specialRequests:o.id}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.id,e)))[0]||null},async create(e){let t=`booking_lock:${e.unitId||e.stayId}`,s=await bt.acquireLock(t,1e4);if(!s)throw new c("Property is currently being booked by someone else. Please try again in a moment.",409);try{return await a.transaction(async r=>{let n=0;if(e.unitId){let $=await r.query.stayUnits.findFirst({where:eq(E.id,e.unitId)});if(!$)throw new c("Unit not found",404);if($.stayId!==e.stayId)throw new c("Unit does not belong to this stay",400);n=$.basePrice;}else {let $=await r.query.stays.findFirst({where:eq(d.id,e.stayId)});if(!$)throw new c("Stay not found",404);n=$.basePrice;}let i=new Date(e.checkIn),p=new Date(e.checkOut),w=Math.ceil((p.getTime()-i.getTime())/(1e3*60*60*24));if(w<1)throw new c("Invalid duration",400);e.totalAmount=n*w;let B=["reserved","confirmed","checked_in","completed"];if(e.unitId&&await r.query.bookings.findFirst({where:and(eq(o.unitId,e.unitId),sql`${o.status} IN ('reserved', 'confirmed', 'checked_in', 'completed')`,lt(o.checkIn,e.checkOut),gt(o.checkOut,e.checkIn))}))throw new c("The unit is already booked for the selected dates",400);e.bookingNumber||(e.bookingNumber=`STY-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`),e.status="reserved",e.paymentStatus="pending";let D=new Date;return D.setHours(D.getHours()+1),e.expiresAt=D,(await r.insert(o).values(e).returning())[0]})}finally{await bt.releaseLock(t,s);}},async transitionStatus(e,t){return await a.transaction(async s=>{let r=await s.query.bookings.findFirst({where:eq(o.id,e)});if(!r)throw new c("Booking not found",404);let n=r.status;if(!({initiated:["reserved","cancelled"],reserved:["confirmed","cancelled","expired"],confirmed:["completed","cancelled","checked_in"],checked_in:["completed","cancelled"],completed:[],cancelled:[],expired:[]}[n]||[]).includes(t))throw new c(`Invalid status transition from ${n} to ${t}`,400);return (await s.update(o).set({status:t,updatedAt:new Date,...t==="confirmed"?{confirmedAt:new Date}:{},...t==="cancelled"?{cancelledAt:new Date}:{}}).where(eq(o.id,e)).returning())[0]})},async getMyBookings(e){return await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.customerId,e)).orderBy(desc(o.createdAt))},async getBookingsByOwner(e){return await a.select({id:o.id,guestName:o.guestName,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.ownerId,e)).orderBy(desc(o.createdAt))}};var se={getAllBookings:m(async(e,t,s)=>{let r=await te.getAll();t.status(200).json({status:"success",results:r.length,data:{bookings:r}});}),getBooking:m(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Booking ID is required",400));let n=await te.getById(r);if(!n)return s(new c("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:n}});}),createBooking:m(async(e,t,s)=>{let{stayId:r,unitId:n,checkIn:i,checkOut:p,guestName:w,guestEmail:B,guestPhone:D}=e.body;if(!r||!i||!p)return s(new c("Missing required fields: stayId, checkIn, checkOut",400));let ge={...e.body,userId:e.user?e.user.id:void 0},$=await te.create(ge);t.status(201).json({status:"success",data:{booking:$}});}),updateBookingStatus:m(async(e,t,s)=>{let{id:r}=e.params,{status:n}=e.body;if(!n)return s(new c("Status is required",400));let i=await te.transitionStatus(r,n);if(!i)return s(new c("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:i}});}),getMyBookings:m(async(e,t,s)=>{let r=await te.getMyBookings(e.user.id);t.status(200).json({status:"success",results:r.length,data:{bookings:r}});}),getOwnerBookings:m(async(e,t,s)=>{let r=await te.getBookingsByOwner(e.user.id);t.status(200).json({status:"success",results:r.length,data:{bookings:r}});})};var Pe={createBooking:z$1.object({body:z$1.object({stayId:z$1.uuid("Invalid Stay ID"),unitId:z$1.uuid("Invalid Unit ID"),checkIn:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-in date format (YYYY-MM-DD)"),checkOut:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-out date format (YYYY-MM-DD)"),totalAmount:z$1.number().positive("Total amount must be positive")})}),getBooking:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Booking ID")})}),updateStatus:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Booking ID")}),body:z$1.object({status:z$1.enum(["pending","confirmed","checked_in","completed","cancelled","no_show"])})})};var re=Router();re.get("/",k,S("admin"),se.getAllBookings);re.get("/my",k,se.getMyBookings);re.get("/my-stays-bookings",k,S("owner","admin"),se.getOwnerBookings);re.get("/:id",k,v(Pe.getBooking),se.getBooking);re.post("/",k,v(Pe.createBooking),se.createBooking);re.patch("/:id/status",k,S("owner","admin"),v(Pe.updateStatus),se.updateBookingStatus);var Zt=re;var H={async getDashboardStats(e){let[t]=await a.select({value:count()}).from(d).where(eq(d.ownerId,e)),[s]=await a.select({value:count()}).from(o).where(eq(o.ownerId,e)),[r]=await a.select({total:sql`COALESCE(SUM(${R.amount}), 0)`}).from(R).innerJoin(o,eq(R.bookingId,o.id)).where(and(eq(o.ownerId,e),eq(R.status,"completed")));return {stays:t.value,bookings:s.value,revenue:r.total}},async getRecentActivity(e,t=5){return await a.select({id:o.id,guestName:o.guestName,status:o.status,amount:o.totalAmount,checkIn:o.checkIn,stayName:d.name}).from(o).innerJoin(d,eq(o.stayId,d.id)).where(eq(o.ownerId,e)).limit(t).orderBy(sql`${o.createdAt} DESC`)},async getAll(){return await a.select().from(u).where(eq(u.role,"owner"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"owner"))))[0]||null},async create(e){let t={...e,role:"owner"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"owner"))))[0]||null}};var je={getAllOwners:m(async(e,t,s)=>{let r=await H.getAll();t.status(200).json({status:"success",results:r.length,data:{owners:r}});}),getOwner:m(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Owner ID is required",400));let n=await H.getById(r);if(!n)return s(new c("No owner found with that ID",404));t.status(200).json({status:"success",data:{owner:n}});}),createOwner:m(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new c("Email is required",400));if(await H.getByEmail(r))return s(new c("Owner with this email already exists",400));let i=await H.create(e.body);t.status(201).json({status:"success",data:{owner:i}});})};var Fe=Router();Fe.get("/",je.getAllOwners);Fe.get("/:id",je.getOwner);Fe.post("/",je.createOwner);var ts=Fe;var be={async getAll(){return await a.select().from(u).where(eq(u.role,"customer"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"customer"))))[0]||null},async create(e){let t={...e,role:"customer"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"customer"))))[0]||null}};var De={getAllCustomers:m(async(e,t,s)=>{let r=await be.getAll();t.status(200).json({status:"success",results:r.length,data:{customers:r}});}),getCustomer:m(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Customer ID is required",400));let n=await be.getById(r);if(!n)return s(new c("No customer found with that ID",404));t.status(200).json({status:"success",data:{customer:n}});}),createCustomer:m(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new c("Email is required",400));if(await be.getByEmail(r))return s(new c("Customer with this email already exists",400));let i=await be.create(e.body);t.status(201).json({status:"success",data:{customer:i}});})};var Ue=Router();Ue.get("/",De.getAllCustomers);Ue.get("/:id",De.getCustomer);Ue.post("/",De.createCustomer);var rs=Ue;var Rt={getProfile:async(e,t,s)=>{try{let r={id:"user_123",email:"user@example.com",role:"customer",createdAt:new Date};return t.status(200).json({status:"success",data:{user:r}})}catch(r){s(r);}},listUsers:async(e,t,s)=>{try{return t.status(200).json({status:"success",data:{users:[]}})}catch(r){s(r);}}};var vt=Router();vt.get("/profile",Rt.getProfile);vt.get("/",Rt.listUsers);var os=vt;var pe={async addMedia(e){return (await a.insert(y).values(e).returning())[0]},async getMediaByStay(e,t=false){let s=t?and(eq(y.stayId,e),isNull(y.unitId)):eq(y.stayId,e);return await a.select().from(y).where(s).orderBy(y.sortOrder)},async getMediaByUnit(e){return await a.select().from(y).where(eq(y.unitId,e)).orderBy(y.sortOrder)},async deleteMedia(e){return (await a.delete(y).where(eq(y.id,e)).returning())[0]},async setCover(e,t,s){return await a.transaction(async r=>{let n=s?and(eq(y.stayId,t),eq(y.unitId,s)):and(eq(y.stayId,t),isNull(y.unitId));return await r.update(y).set({isCover:false}).where(n),(await r.update(y).set({isCover:true}).where(eq(y.id,e)).returning())[0]})},async updateMedia(e,t){return (await a.update(y).set({...t}).where(eq(y.id,e)).returning())[0]}};var ye={uploadMedia:m(async(e,t,s)=>{let{stayId:r,unitId:n,type:i,caption:p,isCover:w}=e.body,{url:B}=e.body;if(e.file&&(B=`${e.protocol}://${e.get("host")}/uploads/${e.file.filename}`),!r||!B)return s(new c("Stay ID and URL/File are required",400));let D=await pe.addMedia({stayId:r,unitId:n||null,url:B,type:i||"image",caption:p,isCover:w==="true"||w===true});t.status(201).json({status:"success",data:{media:D}});}),getStayMedia:m(async(e,t,s)=>{let{stayId:r}=e.params,{propertyOnly:n}=e.query;if(!r)return s(new c("Stay ID is required",400));let i=await pe.getMediaByStay(r,n==="true");t.status(200).json({status:"success",results:i.length,data:{media:i}});}),getUnitMedia:m(async(e,t,s)=>{let{unitId:r}=e.params;if(!r)return s(new c("Unit ID is required",400));let n=await pe.getMediaByUnit(r);t.status(200).json({status:"success",results:n.length,data:{media:n}});}),setCover:m(async(e,t,s)=>{let{id:r}=e.params,{stayId:n,unitId:i}=e.body;if(!n)return s(new c("Stay ID is required in body",400));let p=await pe.setCover(r,n,i);t.status(200).json({status:"success",data:{media:p}});}),removeMedia:m(async(e,t,s)=>{let{id:r}=e.params;if(!await pe.deleteMedia(r))return s(new c("No media found with that ID",404));t.status(204).json({status:"success",data:null});})};var _r=is.diskStorage({destination:(e,t,s)=>{s(null,"uploads/");},filename:(e,t,s)=>{let r=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,t.fieldname+"-"+r+hr.extname(t.originalname));}}),br=(e,t,s)=>{t.mimetype.startsWith("image/")?s(null,true):s(new c("Not an image! Please upload only images.",400),false);},as=is({storage:_r,fileFilter:br,limits:{fileSize:5*1024*1024}});var fe=Router();fe.post("/",as.single("file"),ye.uploadMedia);fe.delete("/:id",ye.removeMedia);fe.patch("/:id/cover",ye.setCover);fe.get("/stays/:stayId",ye.getStayMedia);fe.get("/units/:unitId",ye.getUnitMedia);var us=fe;var Me={generateToken(e){return ur.sign({id:e},f.JWT_SECRET,{expiresIn:f.JWT_EXPIRES_IN})},async comparePasswords(e,t){return await cs.compare(e,t)},async login(e,t){let s=await a.query.users.findFirst({where:eq(u.email,e)});if(!s||!s.password||!await this.comparePasswords(t,s.password))return null;let{password:n,...i}=s;return i},async signup(e){let t=await cs.hash(e.password,12),r=(await a.insert(u).values({...e,password:t}).returning())[0],{password:n,...i}=r;return i}};var oe={sendTokenCookie(e,t,s){let r=Me.generateToken(e.id),n={expires:new Date(Date.now()+parseInt(process.env.JWT_COOKIE_EXPIRES_IN||"30",10)*24*60*60*1e3),httpOnly:true,secure:process.env.NODE_ENV==="production",sameSite:process.env.NODE_ENV==="production"?"none":"lax"};s.cookie("jwt",r,n),s.status(t).json({status:"success",token:r,data:{user:e}});},signup:m(async(e,t,s)=>{let{email:r,password:n,fullName:i,role:p}=e.body;if(!r||!n||!i)return s(new c("Please provide email, password and full name",400));let w=await Me.signup({email:r,password:n,fullName:i,role:p||"customer"});oe.sendTokenCookie(w,201,t);}),login:m(async(e,t,s)=>{let{email:r,password:n}=e.body;if(!r||!n)return s(new c("Please provide email and password",400));let i=await Me.login(r,n);if(!i)return s(new c("Incorrect email or password",401));oe.sendTokenCookie(i,200,t);}),logout:(e,t)=>{t.cookie("jwt","loggedout",{expires:new Date(Date.now()+10*1e3),httpOnly:true}),t.status(200).json({status:"success"});},getMe:(e,t)=>{t.status(200).json({status:"success",data:{user:e.user}});}};var Nt={signup:z$1.object({body:z$1.object({fullName:z$1.string().min(2,"Full name must be at least 2 characters"),email:z$1.string().email("Invalid email address"),password:z$1.string().min(8,"Password must be at least 8 characters"),role:z$1.enum(["customer","owner","admin"]).optional()})}),login:z$1.object({body:z$1.object({email:z$1.string().email("Invalid email address"),password:z$1.string().min(1,"Password is required")})})};var ke=Router();ke.post("/signup",v(Nt.signup),oe.signup);ke.post("/login",v(Nt.login),oe.login);ke.get("/logout",oe.logout);ke.get("/me",k,oe.getMe);var ds=ke;var At={async notify(e){return g.info({to:e.userId,title:e.title,body:e.body},"Notification Dispatched"),true},async sendBookingConfirmation(e){return this.notify({userId:e.userId,title:"Booking Confirmed! \u{1F389}",body:`Your booking ${e.bookingNumber} for ${e.stayName} has been confirmed. Total Paid: NPR ${e.totalAmount}.`,meta:{bookingNumber:e.bookingNumber}})},async notifyOwnerOfNewBooking(e){return this.notify({userId:e.ownerId,title:"New Booking Received!",body:`${e.guestName} just booked your property. Booking Reference: ${e.bookingNumber}.`,meta:{bookingNumber:e.bookingNumber}})}};var $e={async initiateKhalti(e,t){let s=await a.query.bookings.findFirst({where:eq(o.id,e)});if(!s)throw new c("Booking not found",404);let r={return_url:`${f.CORS_ORIGIN}/payment/verify`,website_url:f.CORS_ORIGIN,amount:t*100,purchase_order_id:s.id,purchase_order_name:`Booking ${s.bookingNumber}`};try{let n=await ms.post(`${f.KHALTI_BASE_URL}/epayment/initiate/`,r,{headers:{Authorization:`Key ${f.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}});return await a.insert(R).values({bookingId:s.id,userId:s.customerId,amount:t,method:"khalti",gatewayTxnId:n.data.pidx,status:"initiated"}),n.data}catch(n){let i=n;throw g.error(i.response?.data||i.message,"Khalti Initiation Failed"),new c("Failed to initiate payment with Khalti",502)}},async finalizePayment(e,t,s){return await a.transaction(async r=>{if((await r.query.payments.findFirst({where:eq(R.gatewayTxnId,e)}))?.status==="completed")return {success:true,message:"Payment already processed"};await r.update(R).set({status:"completed",paidAt:new Date,gatewayResponse:s}).where(eq(R.gatewayTxnId,e));let[i]=await r.update(o).set({paymentStatus:"paid",status:"confirmed",confirmedAt:new Date}).where(eq(o.id,t)).returning();if(i){let p=await r.query.stays.findFirst({where:eq(d.id,i.stayId)});At.sendBookingConfirmation({userId:i.customerId,bookingNumber:i.bookingNumber,stayName:p?.name||"Stay",totalAmount:i.totalAmount}).catch(w=>g.error(w,"Guest Notification Failed")),At.notifyOwnerOfNewBooking({ownerId:i.ownerId,bookingNumber:i.bookingNumber,guestName:i.guestName}).catch(w=>g.error(w,"Owner Notification Failed"));}return {success:true,message:"Payment verified and booking confirmed"}})},async verifyKhalti(e){try{let t=await ms.post(`${f.KHALTI_BASE_URL}/epayment/lookup/`,{pidx:e},{headers:{Authorization:`Key ${f.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}}),{status:s,purchase_order_id:r}=t.data;return s==="Completed"?await this.finalizePayment(e,r,t.data):{success:!1,status:s,message:"Payment not completed"}}catch(t){let s=t;throw g.error(s.response?.data||s.message,"Khalti Verification Failed"),new c("Failed to verify payment with Khalti",502)}},async handleKhaltiWebhook(e){let{pidx:t,status:s,purchase_order_id:r}=e;if(s==="Completed"){g.info({pidx:t,purchase_order_id:r},"Received Khalti Webhook: Verifying...");try{let n=await this.verifyKhalti(t);return n.success?(g.info({pidx:t},"Webhook Verification Successful"),{success:!0,message:"Payment verified and processed via webhook"}):(g.warn({pidx:t,verification:n},"Webhook Verification Failed: Payment not completed based on lookup"),{success:!1,message:"Webhook verification failed"})}catch(n){return g.error(n,"Webhook Verification Error"),{success:false,message:"Error verifying webhook payload"}}}return g.warn({pidx:t,status:s},"Received Non-Completed Khalti Webhook or invalid status"),{success:false,message:"Webhook ignored: status not completed"}}};var Ke={initiate:m(async(e,t)=>{let{bookingId:s,amount:r}=e.body,n=await $e.initiateKhalti(s,r);t.status(200).json({status:"success",data:n});}),verify:m(async(e,t)=>{let{pidx:s}=e.body,r=await $e.verifyKhalti(s);t.status(200).json({status:"success",data:r});}),webhook:m(async(e,t)=>{let s=await $e.handleKhaltiWebhook(e.body);t.status(200).json({status:"success",data:s});})};var St={initiate:z$1.object({body:z$1.object({bookingId:z$1.uuid("Invalid Booking ID"),amount:z$1.number().positive("Amount must be positive")})}),verify:z$1.object({body:z$1.object({pidx:z$1.string().min(1,"PIDX is required")})})};var Re=Router();Re.post("/webhook/khalti",Ke.webhook);Re.use(k);Re.post("/initiate",v(St.initiate),Ke.initiate);Re.post("/verify",v(St.verify),Ke.verify);var ls=Re;var ae={async getStats(){let[e]=await a.select({count:count()}).from(u),[t]=await a.select({count:count()}).from(o),[s]=await a.select({count:count()}).from(d),[r]=await a.select({total:sql`COALESCE(SUM(${R.amount}), 0)`}).from(R).where(eq(R.status,"completed"));return {users:e.count,bookings:t.count,stays:s.count,revenue:r.total}},async getRecentActivity(e=10){return await a.select({id:o.id,guestName:o.guestName,status:o.status,amount:o.totalAmount,createdAt:o.createdAt}).from(o).limit(e).orderBy(sql`${o.createdAt} DESC`)},async getAllOwners(e=1,t=10,s=""){let r=(e-1)*t,n=and(eq(u.role,"owner"),s?or$1(ilike(u.fullName,`%${s}%`),ilike(u.email,`%${s}%`)):void 0),i=await a.select({id:u.id,name:u.fullName,email:u.email,avatar:u.avatarUrl,isActive:u.isActive,createdAt:u.createdAt,businessName:j.businessName,verificationStatus:j.verificationStatus,totalEarnings:j.totalEarnings}).from(u).leftJoin(j,eq(u.id,j.userId)).where(n).limit(t).offset(r).orderBy(desc(u.createdAt)),[p]=await a.select({count:count()}).from(u).where(n);return {owners:i,total:p.count,page:e,totalPages:Math.ceil(p.count/t)}},async verifyOwner(e){let[t]=await a.select().from(j).where(eq(j.userId,e));if(!t)throw new Error("Owner profile not found");return await a.update(j).set({verificationStatus:"verified"}).where(eq(j.userId,e)).returning()},async banOwner(e,t){return await a.update(u).set({isActive:!t}).where(eq(u.id,e)).returning()},async getAllBookings(e=1,t=10){let s=(e-1)*t,r=await a.select({id:o.id,bookingNumber:o.bookingNumber,guestName:o.guestName,amount:o.totalAmount,status:o.status,checkIn:o.checkIn,checkOut:o.checkOut,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).limit(t).offset(s).orderBy(desc(o.createdAt)),[n]=await a.select({count:count()}).from(o);return {bookings:r,total:n.count,page:e,totalPages:Math.ceil(n.count/t)}}};var ue={getStats:m(async(e,t)=>{let s=await ae.getStats();t.status(200).json({status:"success",data:{stats:s}});}),getRecentActivity:m(async(e,t)=>{let s=await ae.getRecentActivity();t.status(200).json({status:"success",data:{activity:s}});}),getAllOwners:m(async(e,t)=>{let s=Number(e.query.page)||1,r=Number(e.query.limit)||10,n=e.query.search||"",i=await ae.getAllOwners(s,r,n);t.status(200).json({status:"success",data:i});}),verifyOwner:m(async(e,t)=>{let s=e.params.id;await ae.verifyOwner(s),t.status(200).json({status:"success",message:"Owner verified successfully"});}),banOwner:m(async(e,t)=>{let{ban:s}=e.body,r=e.params.id;await ae.banOwner(r,s),t.status(200).json({status:"success",message:`Owner ${s?"banned":"unbanned"} successfully`});}),getAllBookings:m(async(e,t)=>{let s=Number(e.query.page)||1,r=Number(e.query.limit)||10,n=await ae.getAllBookings(s,r);t.status(200).json({status:"success",data:n});})};var J=Router();J.use(k);J.use(S("admin"));J.get("/stats",ue.getStats);J.get("/activity",ue.getRecentActivity);J.get("/owners",ue.getAllOwners);J.patch("/owners/:id/verify",ue.verifyOwner);J.patch("/owners/:id/ban",ue.banOwner);J.get("/bookings",ue.getAllBookings);var gs=J;var Et={getStats:m(async(e,t,s)=>{let r=e.user?.id;if(!r)return s(new c("User context not found",401));let n=await H.getDashboardStats(r);t.status(200).json({status:"success",data:{stats:n}});}),getRecentActivity:m(async(e,t,s)=>{let r=e.user?.id;if(!r)return s(new c("User context not found",401));let n=await H.getRecentActivity(r);t.status(200).json({status:"success",data:{activity:n}});})};var xe=Router();xe.use(k);xe.use(S("owner"));xe.get("/stats",Et.getStats);xe.get("/activity",Et.getRecentActivity);var ws=xe;var C=Router();C.use("/auth",ds);C.use("/stays",Yt);C.use("/bookings",Zt);C.use("/owners",ts);C.use("/customers",rs);C.use("/users",os);C.use("/media",us);C.use("/payments",ls);C.use("/reviews",Be);C.use("/admin",gs);C.use("/owner/dashboard",ws);var hs=C;var F=Tt(),Pr=rateLimit({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again after 15 minutes",standardHeaders:true,legacyHeaders:false});F.use(Or());F.use(Pr);F.use(qr({origin:f.CORS_ORIGIN,credentials:true}));F.use(Tt.json());F.use(Cr());F.use("/uploads",Tt.static("uploads"));F.get("/health",(e,t)=>{t.status(200).json({status:"success",message:"StaySewa API is healthy"});});F.use("/api",hs);F.use((e,t,s)=>{s(new c(`Can't find ${e.originalUrl} on this server!`,404));});F.use(qt);var _s=F;var bs=async()=>{try{let e=new Date,t=await a.update(o).set({status:"expired",updatedAt:new Date}).where(and(eq(o.status,"reserved"),lt(o.expiresAt,e))).returning({id:o.id});t.length>0&&g.info(`[Cron] Expired ${t.length} stale bookings.`);}catch(e){g.error(e,"[Cron] Failed to run booking expiry job");}};var Mr=async()=>{try{let e=f.PORT||8e3;Ur.schedule("* * * * *",()=>{bs();}),_s.listen(e,()=>{console.log(`\u{1F680} Production-ready server running at http://localhost:${e}`),console.log(`\u{1F4E1} Environment: ${f.NODE_ENV}`);});}catch(e){console.error("\u274C Failed to start server:",e),process.exit(1);}};Mr();