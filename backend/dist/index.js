import Jt,{Router}from'express';import Gt from'dotenv';import Ks from'cors';import zs from'helmet';import $s from'cookie-parser';import Zt from'pino';import {drizzle}from'drizzle-orm/postgres-js';import bs from'postgres';import {pgEnum,pgTable,timestamp,boolean,text,uuid,integer,jsonb,date,numeric,time,inet}from'drizzle-orm/pg-core';import {eq,desc,sql,and,ne as ne$1,lt as lt$1,gt,count,isNull}from'drizzle-orm';import ks from'ioredis';import {z,ZodError}from'zod';import xs from'jsonwebtoken';import Dt from'bcryptjs';import Mt from'axios';import {rateLimit}from'express-rate-limit';var Yt=Object.defineProperty;var Xt=(e,t)=>{for(var s in t)Yt(e,s,{get:t[s],enumerable:true});};Gt.config();var C=(e,t=true)=>{let s=process.env[e];if(t&&!s)throw new Error(`Missing required environment variable: ${e}`);return s||""},m={NODE_ENV:C("NODE_ENV",false)||"development",PORT:parseInt(C("PORT",false)||"4000",10),DATABASE_URL:C("DATABASE_URL",true),JWT_SECRET:C("JWT_SECRET",true),JWT_EXPIRES_IN:C("JWT_EXPIRES_IN",false)||"30d",CORS_ORIGIN:C("CORS_ORIGIN",false)||"http://localhost:3000",KHALTI_SECRET_KEY:C("KHALTI_SECRET_KEY",false)||"mock_secret_key",KHALTI_BASE_URL:C("KHALTI_BASE_URL",false)||"https://a.khalti.com/api/v2",REDIS_URL:C("REDIS_URL",false),JWT_COOKIE_EXPIRES_IN:C("JWT_COOKIE_EXPIRES_IN",false)||"30",SUPABASE_JWT_SECRET:C("SUPABASE_JWT_SECRET",false)};var h=Zt({level:m.NODE_ENV==="development"?"debug":"info",transport:m.NODE_ENV==="development"?{target:"pino-pretty",options:{colorize:true,translateTime:"HH:MM:ss Z",ignore:"pid,hostname"}}:void 0});var ft=(e,t,s,o)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error",m.NODE_ENV==="development"?s.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):e.isOperational?s.status(e.statusCode).json({status:e.status,message:e.message}):(h.error(e,"ERROR \u{1F4A5}"),s.status(500).json({status:"error",message:"Something went very wrong!"}));};var i=class extends Error{statusCode;status;isOperational;constructor(t,s){super(t),this.statusCode=s,this.status=`${s}`.startsWith("4")?"fail":"error",this.isOperational=true,Error.captureStackTrace(this,this.constructor);}};var tt={};Xt(tt,{adjustmentTypeEnum:()=>ze,auditLogs:()=>hs,availability:()=>as,availabilityStatusEnum:()=>Oe,bookingStatusEnum:()=>Pe,bookings:()=>r,cancellationPolicies:()=>is,cancellationTypeEnum:()=>$e,cancelledByEnum:()=>De,customerProfiles:()=>rs,idTypeEnum:()=>fe,mediaTypeEnum:()=>Be,messages:()=>ms,notificationChannelEnum:()=>Le,notifications:()=>ps,ownerProfiles:()=>os,paymentMethodEnum:()=>Ue,paymentStatusEnum:()=>Fe,paymentTxnStatusEnum:()=>Me,payments:()=>b,payoutStatusEnum:()=>Qt,priceRuleTypeEnum:()=>Ke,priceRules:()=>us,reviews:()=>ls,sessions:()=>ns,stayIntentEnum:()=>qe,stayMedia:()=>f,stayStatusEnum:()=>Ce,stayTypeEnum:()=>Te,stayUnits:()=>G,stays:()=>l,supportMessages:()=>fs,supportTickets:()=>ht,ticketCategoryEnum:()=>We,ticketPriorityEnum:()=>Je,ticketStatusEnum:()=>Ve,unitTypeEnum:()=>je,userRoleEnum:()=>Ae,users:()=>u,verificationStatusEnum:()=>Ee});var Ae=pgEnum("user_role",["customer","owner","admin"]),Ee=pgEnum("verification_status",["pending","verified","rejected"]),fe=pgEnum("id_type",["citizenship","national_id_card","passport","national_id"]),Te=pgEnum("stay_type",["hotel","homestay","apartment","room","hostel"]),qe=pgEnum("stay_intent",["short_stay","long_stay","both"]),Ce=pgEnum("stay_status",["draft","pending_review","active","suspended","archived"]),je=pgEnum("unit_type",["private_room","shared_room","entire_place","bed"]),Oe=pgEnum("availability_status",["available","blocked","booked"]),Be=pgEnum("media_type",["image","video"]),Pe=pgEnum("booking_status",["pending","confirmed","checked_in","completed","cancelled","no_show"]),Fe=pgEnum("payment_status",["unpaid","partial","paid","refunded"]),De=pgEnum("cancelled_by",["customer","owner","admin","system"]),Ue=pgEnum("payment_method",["khalti","esewa","bank_transfer","cash","wallet"]),Me=pgEnum("payment_txn_status",["initiated","pending","completed","failed","refunded"]),Ke=pgEnum("price_rule_type",["seasonal","weekend","holiday","long_stay","last_minute"]),ze=pgEnum("adjustment_type",["fixed","percent"]),$e=pgEnum("cancellation_type",["flexible","moderate","strict","non_refundable"]),Qt=pgEnum("payout_status",["pending","processing","completed","failed"]),Le=pgEnum("notification_channel",["in_app","email","sms","push"]),We=pgEnum("ticket_category",["booking","payment","property","account","other"]),Je=pgEnum("ticket_priority",["low","medium","high","urgent"]),Ve=pgEnum("ticket_status",["open","in_progress","waiting_customer","resolved","closed"]);var u=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull().unique(),phone:text("phone").unique(),fullName:text("full_name").notNull(),avatarUrl:text("avatar_url"),role:Ae("role").default("customer").notNull(),password:text("password"),emailVerified:boolean("email_verified").default(false),phoneVerified:boolean("phone_verified").default(false),isActive:boolean("is_active").default(true),lastLoginAt:timestamp("last_login_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),os=pgTable("owner_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),nationality:text("nationality").default("Nepali"),businessName:text("business_name"),panNumber:text("pan_number"),idType:fe("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),bankName:text("bank_name"),bankAccount:text("bank_account"),address:text("address"),verificationStatus:Ee("verification_status").default("pending"),totalEarnings:integer("total_earnings").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),rs=pgTable("customer_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),dateOfBirth:date("date_of_birth"),nationality:text("nationality").default("Nepali"),idType:fe("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),emergencyContact:text("emergency_contact"),preferences:jsonb("preferences").default({}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),ns=pgTable("sessions",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}).notNull(),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var l=pgTable("stays",{id:uuid("id").defaultRandom().primaryKey(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),name:text("name").notNull(),slug:text("slug").notNull().unique(),description:text("description"),type:Te("type").notNull(),intent:qe("intent").default("both"),status:Ce("status").default("draft"),addressLine:text("address_line").notNull(),city:text("city").notNull(),district:text("district").notNull(),province:text("province"),latitude:numeric("latitude",{precision:10,scale:7}),longitude:numeric("longitude",{precision:10,scale:7}),basePrice:integer("base_price").notNull(),maxGuests:integer("max_guests").default(2),amenities:jsonb("amenities").default([]),rules:jsonb("rules").default([]),checkInTime:time("check_in_time").default("14:00:00"),checkOutTime:time("check_out_time").default("11:00:00"),avgRating:numeric("avg_rating",{precision:2,scale:1}).default("0"),totalReviews:integer("total_reviews").default(0),totalBookings:integer("total_bookings").default(0),isFeatured:boolean("is_featured").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),G=pgTable("stay_units",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>l.id).notNull(),name:text("name").notNull(),type:je("type").notNull(),maxOccupancy:integer("max_occupancy").default(2).notNull(),basePrice:integer("base_price").notNull(),quantity:integer("quantity").default(1),amenities:jsonb("amenities").default([]),isActive:boolean("is_active").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),as=pgTable("availability",{id:uuid("id").defaultRandom().primaryKey(),unitId:uuid("unit_id").references(()=>G.id).notNull(),date:date("date",{mode:"string"}).notNull(),availableCount:integer("available_count").notNull(),priceOverride:integer("price_override"),minNights:integer("min_nights").default(1),status:Oe("status").default("available")}),f=pgTable("stay_media",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>l.id).notNull(),unitId:uuid("unit_id").references(()=>G.id),url:text("url").notNull(),thumbnailUrl:text("thumbnail_url"),type:Be("type").default("image"),caption:text("caption"),sortOrder:integer("sort_order").default(0),isCover:boolean("is_cover").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),is=pgTable("cancellation_policies",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>l.id).unique(),type:$e("type").default("moderate"),freeCancelHours:integer("free_cancel_hours").default(48),refundPercentBefore:integer("refund_percent_before").default(100),refundPercentAfter:integer("refund_percent_after").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),us=pgTable("price_rules",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>l.id).notNull(),unitId:uuid("unit_id").references(()=>G.id),name:text("name").notNull(),type:Ke("type").notNull(),adjustmentType:ze("adjustment_type").notNull(),adjustmentValue:integer("adjustment_value").notNull(),startDate:date("start_date",{mode:"string"}),endDate:date("end_date",{mode:"string"}),daysOfWeek:jsonb("days_of_week"),minNights:integer("min_nights"),isActive:boolean("is_active").default(true),priority:integer("priority").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var r=pgTable("bookings",{id:uuid("id").defaultRandom().primaryKey(),bookingNumber:text("booking_number").notNull().unique(),stayId:uuid("stay_id").references(()=>l.id).notNull(),unitId:uuid("unit_id").references(()=>G.id).notNull(),customerId:uuid("customer_id").references(()=>u.id).notNull(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),checkIn:date("check_in",{mode:"string"}).notNull(),checkOut:date("check_out",{mode:"string"}).notNull(),nights:integer("nights").notNull(),guestsCount:integer("guests_count").default(1).notNull(),guestName:text("guest_name").notNull(),guestEmail:text("guest_email"),guestPhone:text("guest_phone"),baseAmount:integer("base_amount").notNull(),taxes:integer("taxes").default(0),serviceFee:integer("service_fee").default(0),discount:integer("discount").default(0),totalAmount:integer("total_amount").notNull(),currency:text("currency").default("NPR"),status:Pe("status").default("pending").notNull(),paymentStatus:Fe("payment_status").default("unpaid").notNull(),specialRequests:text("special_requests"),cancellationReason:text("cancellation_reason"),cancelledBy:De("cancelled_by"),cancelledAt:timestamp("cancelled_at",{withTimezone:true}),confirmedAt:timestamp("confirmed_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),b=pgTable("payments",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>r.id).notNull(),userId:uuid("user_id").references(()=>u.id).notNull(),amount:integer("amount").notNull(),currency:text("currency").default("NPR"),method:Ue("method").notNull(),gatewayTxnId:text("gateway_txn_id"),gatewayResponse:jsonb("gateway_response"),status:Me("status").default("initiated").notNull(),refundAmount:integer("refund_amount").default(0),refundReason:text("refund_reason"),paidAt:timestamp("paid_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),ls=pgTable("reviews",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>r.id).unique().notNull(),stayId:uuid("stay_id").references(()=>l.id).notNull(),reviewerId:uuid("reviewer_id").references(()=>u.id).notNull(),rating:integer("rating").notNull(),cleanliness:integer("cleanliness"),location:integer("location"),value:integer("value"),communication:integer("communication"),comment:text("comment"),ownerReply:text("owner_reply"),ownerRepliedAt:timestamp("owner_replied_at",{withTimezone:true}),isVisible:boolean("is_visible").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var ms=pgTable("messages",{id:uuid("id").defaultRandom().primaryKey(),conversationId:uuid("conversation_id").notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),receiverId:uuid("receiver_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>r.id),content:text("content").notNull(),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),ps=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),type:text("type").notNull(),title:text("title").notNull(),body:text("body"),data:jsonb("data").default({}),channel:Le("channel").default("in_app"),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),sentAt:timestamp("sent_at",{withTimezone:true}).defaultNow()}),ht=pgTable("support_tickets",{id:uuid("id").defaultRandom().primaryKey(),ticketNumber:text("ticket_number").notNull().unique(),userId:uuid("user_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>r.id),category:We("category").notNull(),subject:text("subject").notNull(),priority:Je("priority").default("medium"),status:Ve("status").default("open"),assignedTo:uuid("assigned_to").references(()=>u.id),resolvedAt:timestamp("resolved_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),fs=pgTable("support_messages",{id:uuid("id").defaultRandom().primaryKey(),ticketId:uuid("ticket_id").references(()=>ht.id).notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),content:text("content").notNull(),attachments:jsonb("attachments").default([]),isInternal:boolean("is_internal").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var hs=pgTable("audit_logs",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id),action:text("action").notNull(),entityType:text("entity_type").notNull(),entityId:uuid("entity_id").notNull(),oldValues:jsonb("old_values"),newValues:jsonb("new_values"),ipAddress:inet("ip_address"),userAgent:text("user_agent"),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});Gt.config();var bt=process.env.DATABASE_URL;if(!bt)throw new Error("DATABASE_URL is not set");var Rs=bs(bt,{prepare:false,ssl:"require"}),a=drizzle(Rs,{schema:tt});var Z={async getAll(){return await a.select().from(l)},async getById(e){return await a.query.stays.findFirst({where:eq(l.id,e),with:{stayUnits:true,stayMedia:true}})||null},async create(e){return (await a.insert(l).values(e).returning())[0]},async update(e,t){return (await a.update(l).set({...t,updatedAt:new Date}).where(eq(l.id,e)).returning())[0]},async delete(e){return (await a.delete(l).where(eq(l.id,e)).returning())[0]}};var d=e=>(t,s,o)=>{e(t,s,o).catch(o);};var Nt=m.REDIS_URL,x=null;Nt?(x=new ks(Nt,{maxRetriesPerRequest:3,retryStrategy(e){return Math.min(e*50,2e3)}}),x.on("connect",()=>{h.info("Redis connected successfully");}),x.on("error",e=>{h.error(e,"Redis connection error");})):h.warn("REDIS_URL not provided, caching will be disabled");var Q={getAllStays:d(async(e,t,s)=>{let o="stays:all";if(x){let c=await x.get(o);if(c){let w=JSON.parse(c);return t.status(200).json({status:"success",results:w.length,data:{stays:w}})}}let n=await Z.getAll();x&&await x.set(o,JSON.stringify(n),"EX",300),t.status(200).json({status:"success",results:n.length,data:{stays:n}});}),getStay:d(async(e,t,s)=>{let{id:o}=e.params,n=await Z.getById(o);if(!n)return s(new i("No stay found with that ID",404));t.status(200).json({status:"success",data:{stay:n}});}),createStay:d(async(e,t,s)=>{let o=await Z.create(e.body);x&&await x.del("stays:all"),t.status(201).json({status:"success",data:{stay:o}});}),updateStay:d(async(e,t,s)=>{let{id:o}=e.params,n=await Z.update(o,e.body);if(!n)return s(new i("No stay found with that ID",404));x&&await x.del("stays:all"),t.status(200).json({status:"success",data:{stay:n}});}),deleteStay:d(async(e,t,s)=>{let{id:o}=e.params;if(!await Z.delete(o))return s(new i("No stay found with that ID",404));x&&await x.del("stays:all"),t.status(204).json({status:"success",data:null});})};var N=e=>d(async(t,s,o)=>{try{return await e.parseAsync({body:t.body,query:t.query,params:t.params}),o()}catch(n){if(n instanceof ZodError){let c=n.issues.map(w=>`${w.path.join(".")}: ${w.message}`).join(", ");return o(new i(c,400))}return o(n)}});var E=d(async(e,t,s)=>{let o;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?o=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(o=e.cookies.jwt),!o)return s(new i("You are not logged in! Please log in to get access.",401));if(!m.SUPABASE_JWT_SECRET)return s(new i("Server misconfiguration: Missing SUPABASE_JWT_SECRET",500));try{let n=xs.verify(o,m.SUPABASE_JWT_SECRET),c=n.sub,w=await a.query.users.findFirst({where:eq(u.id,c)});if(!w){let P=n.email||(n.phone?`${n.phone}@phone.staysewa.com`:`no-email-${c}@staysewa.com`);try{w=(await a.insert(u).values({id:c,email:P,fullName:n.user_metadata?.full_name||"StaySewa User",role:"customer",emailVerified:!!n.email,password:null}).returning())[0];}catch{w=await a.query.users.findFirst({where:eq(u.id,c)});}}if(!w)return s(new i("User could not be synced",500));e.user=w,s();}catch{return s(new i("Invalid token",401))}}),U=(...e)=>(t,s,o)=>{if(!t.user||!e.includes(t.user.role))return o(new i("You do not have permission to perform this action",403));o();};var ae={createStay:z.object({body:z.object({name:z.string().min(3,"Name must be at least 3 characters"),type:z.enum(["hostel","flat","homestay"]),addressLine:z.string().min(5,"Address is required"),city:z.string().min(2,"City is required"),district:z.string().min(2,"District is required"),basePrice:z.number().positive("Price must be positive")})}),getStay:z.object({params:z.object({id:z.uuid("Invalid Stay ID")})}),updateStay:z.object({params:z.object({id:z.uuid("Invalid Stay ID")}),body:z.object({name:z.string().min(3,"Name must be at least 3 characters").optional(),type:z.enum(["hostel","homestay","apartment","room","hostel"]).optional(),addressLine:z.string().min(5,"Address is required").optional(),basePrice:z.number().positive("Price must be positive").optional()})}),deleteStay:z.object({params:z.object({id:z.uuid("Invalid Stay ID")})})};var J=Router();J.get("/",Q.getAllStays);J.get("/:id",N(ae.getStay),Q.getStay);J.use(E);J.post("/",U("owner","admin"),N(ae.createStay),Q.createStay);J.patch("/:id",U("owner","admin"),N(ae.updateStay),Q.updateStay);J.delete("/:id",U("owner","admin"),N(ae.deleteStay),Q.deleteStay);var kt=J;var ee={async findOverlap(e,t,s){return await a.query.bookings.findFirst({where:and(eq(r.unitId,e),ne$1(r.status,"cancelled"),lt$1(r.checkIn,s),gt(r.checkOut,t))})},async getAll(){return await a.select({id:r.id,guestName:r.guestName,guestEmail:r.guestEmail,guestPhone:r.guestPhone,checkIn:r.checkIn,checkOut:r.checkOut,status:r.status,totalAmount:r.totalAmount,createdAt:r.createdAt,stayName:l.name}).from(r).leftJoin(l,eq(r.stayId,l.id)).orderBy(desc(r.createdAt))},async getById(e){return (await a.select({id:r.id,guestName:r.guestName,guestEmail:r.guestEmail,guestPhone:r.guestPhone,checkIn:r.checkIn,checkOut:r.checkOut,status:r.status,totalAmount:r.totalAmount,createdAt:r.createdAt,stayName:l.name,specialRequests:r.id}).from(r).leftJoin(l,eq(r.stayId,l.id)).where(eq(r.id,e)))[0]||null},async create(e){return await a.transaction(async t=>{if(await t.execute(sql`SELECT pg_advisory_xact_lock(hashtext(${e.unitId}))`),await t.query.bookings.findFirst({where:and(eq(r.unitId,e.unitId),ne$1(r.status,"cancelled"),lt$1(r.checkIn,e.checkOut),gt(r.checkOut,e.checkIn))}))throw new i("The unit is already booked for the selected dates",400);return e.bookingNumber||(e.bookingNumber=`BS-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`),(await t.insert(r).values(e).returning())[0]})},async updateStatus(e,t){return (await a.update(r).set({status:t}).where(eq(r.id,e)).returning())[0]},async getMyBookings(e){return await a.select({id:r.id,guestName:r.guestName,guestEmail:r.guestEmail,guestPhone:r.guestPhone,checkIn:r.checkIn,checkOut:r.checkOut,status:r.status,totalAmount:r.totalAmount,createdAt:r.createdAt,stayName:l.name}).from(r).leftJoin(l,eq(r.stayId,l.id)).where(eq(r.customerId,e)).orderBy(desc(r.createdAt))}};var te={getAllBookings:d(async(e,t,s)=>{let o=await ee.getAll();t.status(200).json({status:"success",results:o.length,data:{bookings:o}});}),getBooking:d(async(e,t,s)=>{let{id:o}=e.params;if(!o)return s(new i("Booking ID is required",400));let n=await ee.getById(o);if(!n)return s(new i("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:n}});}),createBooking:d(async(e,t,s)=>{let o=await ee.create(e.body);t.status(201).json({status:"success",data:{booking:o}});}),updateBookingStatus:d(async(e,t,s)=>{let{id:o}=e.params,{status:n}=e.body;if(!n)return s(new i("Status is required",400));let c=await ee.updateStatus(o,n);if(!c)return s(new i("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:c}});}),getMyBookings:d(async(e,t,s)=>{let o=await ee.getMyBookings(e.user.id);t.status(200).json({status:"success",results:o.length,data:{bookings:o}});})};var _e={createBooking:z.object({body:z.object({stayId:z.uuid("Invalid Stay ID"),unitId:z.uuid("Invalid Unit ID"),checkIn:z.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-in date format (YYYY-MM-DD)"),checkOut:z.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-out date format (YYYY-MM-DD)"),totalAmount:z.number().positive("Total amount must be positive")})}),updateStatus:z.object({params:z.object({id:z.uuid("Invalid Booking ID")}),body:z.object({status:z.enum(["pending","confirmed","checked_in","completed","cancelled","no_show"])})})};var se=Router();se.get("/",te.getAllBookings);se.get("/my",E,te.getMyBookings);se.get("/:id",N(_e.updateStatus),te.getBooking);se.post("/",N(_e.createBooking),te.createBooking);se.patch("/:id/status",N(_e.updateStatus),te.updateBookingStatus);var Et=se;var K={async getDashboardStats(e){let[t]=await a.select({value:count()}).from(l).where(eq(l.ownerId,e)),[s]=await a.select({value:count()}).from(r).where(eq(r.ownerId,e)),[o]=await a.select({total:sql`COALESCE(SUM(${b.amount}), 0)`}).from(b).innerJoin(r,eq(b.bookingId,r.id)).where(and(eq(r.ownerId,e),eq(b.status,"completed")));return {stays:t.value,bookings:s.value,revenue:o.total}},async getRecentActivity(e,t=5){return await a.select({id:r.id,guestName:r.guestName,status:r.status,amount:r.totalAmount,checkIn:r.checkIn,stayName:l.name}).from(r).innerJoin(l,eq(r.stayId,l.id)).where(eq(r.ownerId,e)).limit(t).orderBy(sql`${r.createdAt} DESC`)},async getAll(){return await a.select().from(u).where(eq(u.role,"owner"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"owner"))))[0]||null},async create(e){let t={...e,role:"owner"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"owner"))))[0]||null}};var be={getAllOwners:d(async(e,t,s)=>{let o=await K.getAll();t.status(200).json({status:"success",results:o.length,data:{owners:o}});}),getOwner:d(async(e,t,s)=>{let{id:o}=e.params;if(!o)return s(new i("Owner ID is required",400));let n=await K.getById(o);if(!n)return s(new i("No owner found with that ID",404));t.status(200).json({status:"success",data:{owner:n}});}),createOwner:d(async(e,t,s)=>{let{email:o}=e.body;if(!o)return s(new i("Email is required",400));if(await K.getByEmail(o))return s(new i("Owner with this email already exists",400));let c=await K.create(e.body);t.status(201).json({status:"success",data:{owner:c}});})};var Ne=Router();Ne.get("/",be.getAllOwners);Ne.get("/:id",be.getOwner);Ne.post("/",be.createOwner);var Ct=Ne;var ue={async getAll(){return await a.select().from(u).where(eq(u.role,"customer"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"customer"))))[0]||null},async create(e){let t={...e,role:"customer"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"customer"))))[0]||null}};var Re={getAllCustomers:d(async(e,t,s)=>{let o=await ue.getAll();t.status(200).json({status:"success",results:o.length,data:{customers:o}});}),getCustomer:d(async(e,t,s)=>{let{id:o}=e.params;if(!o)return s(new i("Customer ID is required",400));let n=await ue.getById(o);if(!n)return s(new i("No customer found with that ID",404));t.status(200).json({status:"success",data:{customer:n}});}),createCustomer:d(async(e,t,s)=>{let{email:o}=e.body;if(!o)return s(new i("Email is required",400));if(await ue.getByEmail(o))return s(new i("Customer with this email already exists",400));let c=await ue.create(e.body);t.status(201).json({status:"success",data:{customer:c}});})};var ke=Router();ke.get("/",Re.getAllCustomers);ke.get("/:id",Re.getCustomer);ke.post("/",Re.createCustomer);var Ot=ke;var rt={getProfile:async(e,t,s)=>{try{let o={id:"user_123",email:"user@example.com",role:"customer",createdAt:new Date};return t.status(200).json({status:"success",data:{user:o}})}catch(o){s(o);}},listUsers:async(e,t,s)=>{try{return t.status(200).json({status:"success",data:{users:[]}})}catch(o){s(o);}}};var nt=Router();nt.get("/profile",rt.getProfile);nt.get("/",rt.listUsers);var Bt=nt;var oe={async addMedia(e){return (await a.insert(f).values(e).returning())[0]},async getMediaByStay(e,t=false){let s=t?and(eq(f.stayId,e),isNull(f.unitId)):eq(f.stayId,e);return await a.select().from(f).where(s).orderBy(f.sortOrder)},async getMediaByUnit(e){return await a.select().from(f).where(eq(f.unitId,e)).orderBy(f.sortOrder)},async deleteMedia(e){return (await a.delete(f).where(eq(f.id,e)).returning())[0]},async setCover(e,t,s){return await a.transaction(async o=>{let n=s?and(eq(f.stayId,t),eq(f.unitId,s)):and(eq(f.stayId,t),isNull(f.unitId));return await o.update(f).set({isCover:false}).where(n),(await o.update(f).set({isCover:true}).where(eq(f.id,e)).returning())[0]})},async updateMedia(e,t){return (await a.update(f).set({...t}).where(eq(f.id,e)).returning())[0]}};var re={uploadMedia:d(async(e,t,s)=>{let{stayId:o,unitId:n,url:c,type:w,caption:P,isCover:Se}=e.body;if(!o||!c)return s(new i("Stay ID and URL are required",400));let Ht=await oe.addMedia({stayId:o,unitId:n||null,url:c,type:w||"image",caption:P,isCover:Se||false});t.status(201).json({status:"success",data:{media:Ht}});}),getStayMedia:d(async(e,t,s)=>{let{stayId:o}=e.params,{propertyOnly:n}=e.query;if(!o)return s(new i("Stay ID is required",400));let c=await oe.getMediaByStay(o,n==="true");t.status(200).json({status:"success",results:c.length,data:{media:c}});}),getUnitMedia:d(async(e,t,s)=>{let{unitId:o}=e.params;if(!o)return s(new i("Unit ID is required",400));let n=await oe.getMediaByUnit(o);t.status(200).json({status:"success",results:n.length,data:{media:n}});}),setCover:d(async(e,t,s)=>{let{id:o}=e.params,{stayId:n,unitId:c}=e.body;if(!n)return s(new i("Stay ID is required in body",400));let w=await oe.setCover(o,n,c);t.status(200).json({status:"success",data:{media:w}});}),removeMedia:d(async(e,t,s)=>{let{id:o}=e.params;if(!await oe.deleteMedia(o))return s(new i("No media found with that ID",404));t.status(204).json({status:"success",data:null});})};var ne=Router();ne.post("/",re.uploadMedia);ne.delete("/:id",re.removeMedia);ne.patch("/:id/cover",re.setCover);ne.get("/stays/:stayId",re.getStayMedia);ne.get("/units/:unitId",re.getUnitMedia);var Ft=ne;var ve={generateToken(e){return xs.sign({id:e},m.JWT_SECRET,{expiresIn:m.JWT_EXPIRES_IN})},async comparePasswords(e,t){return await Dt.compare(e,t)},async login(e,t){let s=await a.query.users.findFirst({where:eq(u.email,e)});if(!s||!s.password||!await this.comparePasswords(t,s.password))return null;let{password:n,...c}=s;return c},async signup(e){let t=await Dt.hash(e.password,12),o=(await a.insert(u).values({...e,password:t}).returning())[0],{password:n,...c}=o;return c}};var V={sendTokenCookie(e,t,s){let o=ve.generateToken(e.id),n={expires:new Date(Date.now()+parseInt(process.env.JWT_COOKIE_EXPIRES_IN||"30",10)*24*60*60*1e3),httpOnly:true,secure:process.env.NODE_ENV==="production",sameSite:process.env.NODE_ENV==="production"?"none":"lax"};s.cookie("jwt",o,n),s.status(t).json({status:"success",token:o,data:{user:e}});},signup:d(async(e,t,s)=>{let{email:o,password:n,fullName:c,role:w}=e.body;if(!o||!n||!c)return s(new i("Please provide email, password and full name",400));let P=await ve.signup({email:o,password:n,fullName:c,role:w||"customer"});V.sendTokenCookie(P,201,t);}),login:d(async(e,t,s)=>{let{email:o,password:n}=e.body;if(!o||!n)return s(new i("Please provide email and password",400));let c=await ve.login(o,n);if(!c)return s(new i("Incorrect email or password",401));V.sendTokenCookie(c,200,t);}),logout:(e,t)=>{t.cookie("jwt","loggedout",{expires:new Date(Date.now()+10*1e3),httpOnly:true}),t.status(200).json({status:"success"});},getMe:(e,t)=>{t.status(200).json({status:"success",data:{user:e.user}});}};var it={signup:z.object({body:z.object({fullName:z.string().min(2,"Full name must be at least 2 characters"),email:z.string().email("Invalid email address"),password:z.string().min(8,"Password must be at least 8 characters"),role:z.enum(["customer","owner","admin"]).optional()})}),login:z.object({body:z.object({email:z.string().email("Invalid email address"),password:z.string().min(1,"Password is required")})})};var ce=Router();ce.post("/signup",N(it.signup),V.signup);ce.post("/login",N(it.login),V.login);ce.get("/logout",V.logout);ce.get("/me",E,V.getMe);var Ut=ce;var ut={async notify(e){return h.info({to:e.userId,title:e.title,body:e.body},"Notification Dispatched"),true},async sendBookingConfirmation(e){return this.notify({userId:e.userId,title:"Booking Confirmed! \u{1F389}",body:`Your booking ${e.bookingNumber} for ${e.stayName} has been confirmed. Total Paid: NPR ${e.totalAmount}.`,meta:{bookingNumber:e.bookingNumber}})},async notifyOwnerOfNewBooking(e){return this.notify({userId:e.ownerId,title:"New Booking Received!",body:`${e.guestName} just booked your property. Booking Reference: ${e.bookingNumber}.`,meta:{bookingNumber:e.bookingNumber}})}};var xe={async initiateKhalti(e,t){let s=await a.query.bookings.findFirst({where:eq(r.id,e)});if(!s)throw new i("Booking not found",404);let o={return_url:`${m.CORS_ORIGIN}/payment/verify`,website_url:m.CORS_ORIGIN,amount:t*100,purchase_order_id:s.id,purchase_order_name:`Booking ${s.bookingNumber}`};try{let n=await Mt.post(`${m.KHALTI_BASE_URL}/epayment/initiate/`,o,{headers:{Authorization:`Key ${m.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}});return await a.insert(b).values({bookingId:s.id,userId:s.customerId,amount:t,method:"khalti",gatewayTxnId:n.data.pidx,status:"initiated"}),n.data}catch(n){let c=n;throw h.error(c.response?.data||c.message,"Khalti Initiation Failed"),new i("Failed to initiate payment with Khalti",502)}},async finalizePayment(e,t,s){return await a.transaction(async o=>{if((await o.query.payments.findFirst({where:eq(b.gatewayTxnId,e)}))?.status==="completed")return {success:true,message:"Payment already processed"};await o.update(b).set({status:"completed",paidAt:new Date,gatewayResponse:s}).where(eq(b.gatewayTxnId,e));let[c]=await o.update(r).set({paymentStatus:"paid",status:"confirmed",confirmedAt:new Date}).where(eq(r.id,t)).returning();if(c){let w=await o.query.stays.findFirst({where:eq(l.id,c.stayId)});ut.sendBookingConfirmation({userId:c.customerId,bookingNumber:c.bookingNumber,stayName:w?.name||"Stay",totalAmount:c.totalAmount}).catch(P=>h.error(P,"Guest Notification Failed")),ut.notifyOwnerOfNewBooking({ownerId:c.ownerId,bookingNumber:c.bookingNumber,guestName:c.guestName}).catch(P=>h.error(P,"Owner Notification Failed"));}return {success:true,message:"Payment verified and booking confirmed"}})},async verifyKhalti(e){try{let t=await Mt.post(`${m.KHALTI_BASE_URL}/epayment/lookup/`,{pidx:e},{headers:{Authorization:`Key ${m.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}}),{status:s,purchase_order_id:o}=t.data;return s==="Completed"?await this.finalizePayment(e,o,t.data):{success:!1,status:s,message:"Payment not completed"}}catch(t){let s=t;throw h.error(s.response?.data||s.message,"Khalti Verification Failed"),new i("Failed to verify payment with Khalti",502)}},async handleKhaltiWebhook(e){let{pidx:t,status:s,purchase_order_id:o}=e;if(s==="Completed"){h.info({pidx:t,purchase_order_id:o},"Received Khalti Webhook: Verifying...");try{let n=await this.verifyKhalti(t);return n.success?(h.info({pidx:t},"Webhook Verification Successful"),{success:!0,message:"Payment verified and processed via webhook"}):(h.warn({pidx:t,verification:n},"Webhook Verification Failed: Payment not completed based on lookup"),{success:!1,message:"Webhook verification failed"})}catch(n){return h.error(n,"Webhook Verification Error"),{success:false,message:"Error verifying webhook payload"}}}return h.warn({pidx:t,status:s},"Received Non-Completed Khalti Webhook or invalid status"),{success:false,message:"Webhook ignored: status not completed"}}};var Ie={initiate:d(async(e,t)=>{let{bookingId:s,amount:o}=e.body,n=await xe.initiateKhalti(s,o);t.status(200).json({status:"success",data:n});}),verify:d(async(e,t)=>{let{pidx:s}=e.body,o=await xe.verifyKhalti(s);t.status(200).json({status:"success",data:o});}),webhook:d(async(e,t)=>{let s=await xe.handleKhaltiWebhook(e.body);t.status(200).json({status:"success",data:s});})};var ct={initiate:z.object({body:z.object({bookingId:z.uuid("Invalid Booking ID"),amount:z.number().positive("Amount must be positive")})}),verify:z.object({body:z.object({pidx:z.string().min(1,"PIDX is required")})})};var le=Router();le.post("/webhook/khalti",Ie.webhook);le.use(E);le.post("/initiate",N(ct.initiate),Ie.initiate);le.post("/verify",N(ct.verify),Ie.verify);var Kt=le;var lt={async getStats(){let[e]=await a.select({value:count()}).from(u),[t]=await a.select({value:count()}).from(r),[s]=await a.select({value:count()}).from(l),[o]=await a.select({total:sql`COALESCE(SUM(${b.amount}), 0)`}).from(b).where(eq(b.status,"completed"));return {users:e.value,bookings:t.value,stays:s.value,revenue:o.total}},async getRecentActivity(e=10){return await a.select({id:r.id,guestName:r.guestName,status:r.status,amount:r.totalAmount,createdAt:r.createdAt}).from(r).limit(e).orderBy(sql`${r.createdAt} DESC`)}};var mt={getStats:d(async(e,t)=>{let s=await lt.getStats();t.status(200).json({status:"success",data:{stats:s}});}),getRecentActivity:d(async(e,t)=>{let s=await lt.getRecentActivity();t.status(200).json({status:"success",data:{activity:s}});})};var me=Router();me.use(E);me.use(U("admin"));me.get("/stats",mt.getStats);me.get("/activity",mt.getRecentActivity);var $t=me;var pt={getStats:d(async(e,t,s)=>{let o=e.user?.id;if(!o)return s(new i("User context not found",401));let n=await K.getDashboardStats(o);t.status(200).json({status:"success",data:{stats:n}});}),getRecentActivity:d(async(e,t,s)=>{let o=e.user?.id;if(!o)return s(new i("User context not found",401));let n=await K.getRecentActivity(o);t.status(200).json({status:"success",data:{activity:n}});})};var pe=Router();pe.use(E);pe.use(U("owner"));pe.get("/stats",pt.getStats);pe.get("/activity",pt.getRecentActivity);var Lt=pe;var j=Router();j.use("/auth",Ut);j.use("/stays",kt);j.use("/bookings",Et);j.use("/owners",Ct);j.use("/customers",Ot);j.use("/users",Bt);j.use("/media",Ft);j.use("/payments",Kt);j.use("/admin",$t);j.use("/owner/dashboard",Lt);var Wt=j;var B=Jt(),Ws=rateLimit({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again after 15 minutes",standardHeaders:true,legacyHeaders:false});B.use(zs());B.use(Ws);B.use(Ks({origin:m.CORS_ORIGIN,credentials:true}));B.use(Jt.json());B.use($s());B.get("/health",(e,t)=>{t.status(200).json({status:"success",message:"StaySewa API is healthy"});});B.use("/api",Wt);B.use((e,t,s)=>{s(new i(`Can't find ${e.originalUrl} on this server!`,404));});B.use(ft);var Vt=B;var Js=async()=>{try{let e=m.PORT||8e3;Vt.listen(e,()=>{console.log(`\u{1F680} Production-ready server running at http://localhost:${e}`),console.log(`\u{1F4E1} Environment: ${m.NODE_ENV}`);});}catch(e){console.error("\u274C Failed to start server:",e),process.exit(1);}};Js();