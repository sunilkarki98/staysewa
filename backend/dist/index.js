import At,{Router}from'express';import hs from'dotenv';import Nr from'cors';import vr from'helmet';import Ir from'cookie-parser';import bs from'pino';import {drizzle}from'drizzle-orm/postgres-js';import zs from'postgres';import {pgEnum,pgTable,timestamp,boolean,text,uuid,integer,jsonb,date,numeric,time,uniqueIndex,check,inet}from'drizzle-orm/pg-core';import {sql,and,eq,lt,gte,lte,desc,gt as gt$1,ne,count,isNull,or,ilike}from'drizzle-orm';import Gs from'slugify';import {v4}from'uuid';import Zs from'ioredis';import {z as z$1,ZodError}from'zod';import er from'jsonwebtoken';import ts from'multer';import dr from'path';import os from'bcryptjs';import is from'axios';import {rateLimit}from'express-rate-limit';import Tr from'node-cron';var gs=Object.defineProperty;var ws=(e,t)=>{for(var s in t)gs(e,s,{get:t[s],enumerable:true});};hs.config();var B=(e,t=true)=>{let s=process.env[e];if(t&&!s)throw new Error(`Missing required environment variable: ${e}`);return s||""},y={NODE_ENV:B("NODE_ENV",false)||"development",PORT:parseInt(B("PORT",false)||"4000",10),DATABASE_URL:B("DATABASE_URL",true),JWT_SECRET:B("JWT_SECRET",true),JWT_EXPIRES_IN:B("JWT_EXPIRES_IN",false)||"30d",CORS_ORIGIN:B("CORS_ORIGIN",false)||"http://localhost:3000",KHALTI_SECRET_KEY:B("KHALTI_SECRET_KEY",false)||"mock_secret_key",KHALTI_BASE_URL:B("KHALTI_BASE_URL",false)||"https://a.khalti.com/api/v2",REDIS_URL:B("REDIS_URL",false),JWT_COOKIE_EXPIRES_IN:B("JWT_COOKIE_EXPIRES_IN",false)||"30",SUPABASE_JWT_SECRET:B("SUPABASE_JWT_SECRET",false)};var f=bs({level:y.NODE_ENV==="development"?"debug":"info",transport:y.NODE_ENV==="development"?{target:"pino-pretty",options:{colorize:true,translateTime:"HH:MM:ss Z",ignore:"pid,hostname"}}:void 0});var St=(e,t,s,r)=>{e.statusCode=e.statusCode||500,e.status=e.status||"error",y.NODE_ENV==="development"?s.status(e.statusCode).json({status:e.status,error:e,message:e.message,stack:e.stack}):e.isOperational?s.status(e.statusCode).json({status:e.status,message:e.message}):(f.error(e,"ERROR \u{1F4A5}"),s.status(500).json({status:"error",message:"Something went very wrong!"}));};var c=class extends Error{statusCode;status;isOperational;constructor(t,s){super(t),this.statusCode=s,this.status=`${s}`.startsWith("4")?"fail":"error",this.isOperational=true,Error.captureStackTrace(this,this.constructor);}};var yt={};ws(yt,{adjustmentTypeEnum:()=>st,auditLogs:()=>Ms,availability:()=>As,availabilityStatusEnum:()=>Ye,bookingStatusEnum:()=>Ge,bookings:()=>o,cancellationPolicies:()=>Ss,cancellationTypeEnum:()=>rt,cancelledByEnum:()=>Ze,customerProfiles:()=>vs,idTypeEnum:()=>Ie,mediaTypeEnum:()=>He,messages:()=>Ps,notificationChannelEnum:()=>ot,notifications:()=>js,ownerProfiles:()=>P,paymentMethodEnum:()=>Qe,paymentStatusEnum:()=>Xe,paymentTxnStatusEnum:()=>et,payments:()=>N,payoutStatusEnum:()=>_s,priceRuleTypeEnum:()=>tt,priceRules:()=>Es,reviews:()=>z,sessions:()=>Is,stayIntentEnum:()=>We,stayMedia:()=>w,stayStatusEnum:()=>Je,stayTypeEnum:()=>Le,stayUnits:()=>D,stays:()=>d,supportMessages:()=>Fs,supportTickets:()=>Pt,ticketCategoryEnum:()=>nt,ticketPriorityEnum:()=>it,ticketStatusEnum:()=>at,unitTypeEnum:()=>Ve,userRoleEnum:()=>Ke,users:()=>u,verificationStatusEnum:()=>ze});var Ke=pgEnum("user_role",["customer","owner","admin"]),ze=pgEnum("verification_status",["pending","verified","rejected"]),Ie=pgEnum("id_type",["citizenship","national_id_card","passport","national_id"]),Le=pgEnum("stay_type",["hotel","homestay","apartment","room","hostel"]),We=pgEnum("stay_intent",["short_stay","long_stay","both"]),Je=pgEnum("stay_status",["draft","pending_review","active","suspended","archived"]),Ve=pgEnum("unit_type",["private_room","shared_room","entire_place","bed"]),Ye=pgEnum("availability_status",["available","blocked","booked"]),He=pgEnum("media_type",["image","video"]),Ge=pgEnum("booking_status",["initiated","reserved","confirmed","checked_in","completed","cancelled","expired","no_show","pending"]),Xe=pgEnum("payment_status",["not_required","pending","success","failed","refunded","unpaid","paid"]),Ze=pgEnum("cancelled_by",["customer","owner","admin","system"]),Qe=pgEnum("payment_method",["khalti","esewa","bank_transfer","cash","wallet"]),et=pgEnum("payment_txn_status",["initiated","pending","completed","failed","refunded"]),tt=pgEnum("price_rule_type",["seasonal","weekend","holiday","long_stay","last_minute"]),st=pgEnum("adjustment_type",["fixed","percent"]),rt=pgEnum("cancellation_type",["flexible","moderate","strict","non_refundable"]),_s=pgEnum("payout_status",["pending","processing","completed","failed"]),ot=pgEnum("notification_channel",["in_app","email","sms","push"]),nt=pgEnum("ticket_category",["booking","payment","property","account","other"]),it=pgEnum("ticket_priority",["low","medium","high","urgent"]),at=pgEnum("ticket_status",["open","in_progress","waiting_customer","resolved","closed"]);var u=pgTable("users",{id:uuid("id").defaultRandom().primaryKey(),email:text("email").notNull().unique(),phone:text("phone").unique(),fullName:text("full_name").notNull(),avatarUrl:text("avatar_url"),role:Ke("role").default("customer").notNull(),password:text("password"),emailVerified:boolean("email_verified").default(false),phoneVerified:boolean("phone_verified").default(false),isActive:boolean("is_active").default(true),lastLoginAt:timestamp("last_login_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),P=pgTable("owner_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),nationality:text("nationality").default("Nepali"),businessName:text("business_name"),panNumber:text("pan_number"),idType:Ie("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),bankName:text("bank_name"),bankAccount:text("bank_account"),address:text("address"),verificationStatus:ze("verification_status").default("pending"),totalEarnings:integer("total_earnings").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),vs=pgTable("customer_profiles",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull().unique(),dateOfBirth:date("date_of_birth"),nationality:text("nationality").default("Nepali"),idType:Ie("id_type"),idNumber:text("id_number"),idFrontUrl:text("id_front_url"),idBackUrl:text("id_back_url"),emergencyContact:text("emergency_contact"),preferences:jsonb("preferences").default({}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Is=pgTable("sessions",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),token:text("token").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}).notNull(),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var d=pgTable("stays",{id:uuid("id").defaultRandom().primaryKey(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),name:text("name").notNull(),slug:text("slug").notNull().unique(),description:text("description"),type:Le("type").notNull(),intent:We("intent").default("both"),status:Je("status").default("draft"),addressLine:text("address_line").notNull(),city:text("city").notNull(),district:text("district").notNull(),province:text("province"),latitude:numeric("latitude",{precision:10,scale:7}),longitude:numeric("longitude",{precision:10,scale:7}),basePrice:integer("base_price").notNull(),maxGuests:integer("max_guests").default(2),amenities:jsonb("amenities").default([]),rules:jsonb("rules").default([]),checkInTime:time("check_in_time").default("14:00:00"),checkOutTime:time("check_out_time").default("11:00:00"),avgRating:numeric("avg_rating",{precision:2,scale:1}).default("0"),totalReviews:integer("total_reviews").default(0),totalBookings:integer("total_bookings").default(0),isFeatured:boolean("is_featured").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),D=pgTable("stay_units",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),name:text("name").notNull(),type:Ve("type").notNull(),maxOccupancy:integer("max_occupancy").default(2).notNull(),basePrice:integer("base_price").notNull(),quantity:integer("quantity").default(1),amenities:jsonb("amenities").default([]),isActive:boolean("is_active").default(true),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),As=pgTable("availability",{id:uuid("id").defaultRandom().primaryKey(),unitId:uuid("unit_id").references(()=>D.id).notNull(),date:date("date",{mode:"string"}).notNull(),availableCount:integer("available_count").notNull(),priceOverride:integer("price_override"),minNights:integer("min_nights").default(1),status:Ye("status").default("available")},e=>({unq:uniqueIndex("availability_unit_date_idx").on(e.unitId,e.date)})),w=pgTable("stay_media",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>D.id),url:text("url").notNull(),thumbnailUrl:text("thumbnail_url"),type:He("type").default("image"),caption:text("caption"),sortOrder:integer("sort_order").default(0),isCover:boolean("is_cover").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Ss=pgTable("cancellation_policies",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).unique(),type:rt("type").default("moderate"),freeCancelHours:integer("free_cancel_hours").default(48),refundPercentBefore:integer("refund_percent_before").default(100),refundPercentAfter:integer("refund_percent_after").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Es=pgTable("price_rules",{id:uuid("id").defaultRandom().primaryKey(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>D.id),name:text("name").notNull(),type:tt("type").notNull(),adjustmentType:st("adjustment_type").notNull(),adjustmentValue:integer("adjustment_value").notNull(),startDate:date("start_date",{mode:"string"}),endDate:date("end_date",{mode:"string"}),daysOfWeek:jsonb("days_of_week"),minNights:integer("min_nights"),isActive:boolean("is_active").default(true),priority:integer("priority").default(0),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var o=pgTable("bookings",{id:uuid("id").defaultRandom().primaryKey(),bookingNumber:text("booking_number").notNull().unique(),stayId:uuid("stay_id").references(()=>d.id).notNull(),unitId:uuid("unit_id").references(()=>D.id).notNull(),customerId:uuid("customer_id").references(()=>u.id).notNull(),ownerId:uuid("owner_id").references(()=>u.id).notNull(),checkIn:date("check_in",{mode:"string"}).notNull(),checkOut:date("check_out",{mode:"string"}).notNull(),nights:integer("nights").notNull(),guestsCount:integer("guests_count").default(1).notNull(),guestName:text("guest_name").notNull(),guestEmail:text("guest_email"),guestPhone:text("guest_phone"),baseAmount:integer("base_amount").notNull(),taxes:integer("taxes").default(0),serviceFee:integer("service_fee").default(0),discount:integer("discount").default(0),totalAmount:integer("total_amount").notNull(),currency:text("currency").default("NPR"),status:Ge("status").default("initiated").notNull(),paymentStatus:Xe("payment_status").default("not_required").notNull(),expiresAt:timestamp("expires_at",{withTimezone:true}),metadata:jsonb("metadata"),specialRequests:text("special_requests"),cancellationReason:text("cancellation_reason"),cancelledBy:Ze("cancelled_by"),cancelledAt:timestamp("cancelled_at",{withTimezone:true}),confirmedAt:timestamp("confirmed_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow(),updatedAt:timestamp("updated_at",{withTimezone:true}).defaultNow()}),N=pgTable("payments",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>o.id).notNull(),userId:uuid("user_id").references(()=>u.id).notNull(),amount:integer("amount").notNull(),currency:text("currency").default("NPR"),method:Qe("method").notNull(),gatewayTxnId:text("gateway_txn_id"),gatewayResponse:jsonb("gateway_response"),status:et("status").default("initiated").notNull(),refundAmount:integer("refund_amount").default(0),refundReason:text("refund_reason"),paidAt:timestamp("paid_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var z=pgTable("reviews",{id:uuid("id").defaultRandom().primaryKey(),bookingId:uuid("booking_id").references(()=>o.id).unique().notNull(),stayId:uuid("stay_id").references(()=>d.id).notNull(),userId:uuid("user_id").references(()=>u.id).notNull(),rating:integer("rating").notNull(),comment:text("comment"),updatedAt:timestamp("updated_at").defaultNow(),createdAt:timestamp("created_at").defaultNow()},e=>({ratingCheck:check("rating_check",sql`${e.rating} >= 1 AND ${e.rating} <= 5`)}));var Ps=pgTable("messages",{id:uuid("id").defaultRandom().primaryKey(),conversationId:uuid("conversation_id").notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),receiverId:uuid("receiver_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>o.id),content:text("content").notNull(),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),js=pgTable("notifications",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id).notNull(),type:text("type").notNull(),title:text("title").notNull(),body:text("body"),data:jsonb("data").default({}),channel:ot("channel").default("in_app"),isRead:boolean("is_read").default(false),readAt:timestamp("read_at",{withTimezone:true}),sentAt:timestamp("sent_at",{withTimezone:true}).defaultNow()}),Pt=pgTable("support_tickets",{id:uuid("id").defaultRandom().primaryKey(),ticketNumber:text("ticket_number").notNull().unique(),userId:uuid("user_id").references(()=>u.id).notNull(),bookingId:uuid("booking_id").references(()=>o.id),category:nt("category").notNull(),subject:text("subject").notNull(),priority:it("priority").default("medium"),status:at("status").default("open"),assignedTo:uuid("assigned_to").references(()=>u.id),resolvedAt:timestamp("resolved_at",{withTimezone:true}),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()}),Fs=pgTable("support_messages",{id:uuid("id").defaultRandom().primaryKey(),ticketId:uuid("ticket_id").references(()=>Pt.id).notNull(),senderId:uuid("sender_id").references(()=>u.id).notNull(),content:text("content").notNull(),attachments:jsonb("attachments").default([]),isInternal:boolean("is_internal").default(false),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});var Ms=pgTable("audit_logs",{id:uuid("id").defaultRandom().primaryKey(),userId:uuid("user_id").references(()=>u.id),action:text("action").notNull(),entityType:text("entity_type").notNull(),entityId:uuid("entity_id").notNull(),oldValues:jsonb("old_values"),newValues:jsonb("new_values"),ipAddress:inet("ip_address"),userAgent:text("user_agent"),createdAt:timestamp("created_at",{withTimezone:true}).defaultNow()});hs.config();var Ft=process.env.DATABASE_URL;if(!Ft)throw new Error("DATABASE_URL is not set");var Ws=zs(Ft,{prepare:false,ssl:"require"}),a=drizzle(Ws,{schema:yt});var de={async search(e){let{location:t,minPrice:s,maxPrice:r,type:n,guests:i}=e,p=[];return t&&t!=="all"&&p.push(sql`lower(${d.city}) LIKE ${`%${t.toLowerCase()}%`} OR lower(${d.addressLine}) LIKE ${`%${t.toLowerCase()}%`} OR lower(${d.district}) LIKE ${`%${t.toLowerCase()}%`}`),n&&n!=="all"&&p.push(eq(d.type,n)),s&&p.push(gte(d.basePrice,s)),r&&p.push(lte(d.basePrice,r)),i&&p.push(gte(d.maxGuests,i)),await a.query.stays.findMany({where:and(...p),with:{stayMedia:true,stayUnits:true},orderBy:desc(d.createdAt)})},async getAll(){return this.search({})},async getById(e){return await a.query.stays.findFirst({where:eq(d.id,e),with:{stayUnits:true,stayMedia:true}})||null},async create(e){return await a.transaction(async t=>{let r=`${Gs(e.name,{lower:true,strict:true})}-${v4().slice(0,8)}`,{stayUnits:n,images:i,...p}=e,[g]=await t.insert(d).values({...p,slug:r}).returning();if(n&&n.length>0){let C=n.map(F=>({...F,stayId:g.id}));await t.insert(D).values(C);}if(i&&i.length>0){let C=i.map((F,fe)=>({stayId:g.id,url:F,type:"image",sortOrder:fe,isCover:fe===0}));await t.insert(w).values(C);}return g})},async update(e,t){return (await a.update(d).set({...t,updatedAt:new Date}).where(eq(d.id,e)).returning())[0]},async delete(e){return (await a.delete(d).where(eq(d.id,e)).returning())[0]}};var l=e=>(t,s,r)=>{e(t,s,r).catch(r);};var $t=y.REDIS_URL,_=null;$t?(_=new Zs($t,{maxRetriesPerRequest:3,retryStrategy(e){return Math.min(e*50,2e3)}}),_.on("connect",()=>{f.info("Redis connected successfully");}),_.on("error",e=>{f.error(e,"Redis connection error");})):f.warn("REDIS_URL not provided, caching will be disabled");var le={getAllStays:l(async(e,t,s)=>{let r="stays:all";if(_){let p=await _.get(r);if(p){let g=JSON.parse(p);return t.status(200).json({status:"success",results:g.length,data:{stays:g}})}}let n={location:e.query.location,minPrice:e.query.minPrice?Number(e.query.minPrice):void 0,maxPrice:e.query.maxPrice?Number(e.query.maxPrice):void 0,type:e.query.category,guests:e.query.guests?Number(e.query.guests):void 0,checkIn:e.query.checkIn,checkOut:e.query.checkOut},i=await de.search(n);_&&await _.set(r,JSON.stringify(i),"EX",300),t.status(200).json({status:"success",results:i.length,data:{stays:i}});}),getStay:l(async(e,t,s)=>{let{id:r}=e.params,n=await de.getById(r);if(!n)return s(new c("No stay found with that ID",404));t.status(200).json({status:"success",data:{stay:n}});}),createStay:l(async(e,t,s)=>{let r=e.user?.id,n=await de.create({...e.body,ownerId:r||e.body.ownerId});_&&await _.del("stays:all"),t.status(201).json({status:"success",data:{stay:n}});}),updateStay:l(async(e,t,s)=>{let{id:r}=e.params,n=await de.update(r,e.body);if(!n)return s(new c("No stay found with that ID",404));_&&await _.del("stays:all"),t.status(200).json({status:"success",data:{stay:n}});}),deleteStay:l(async(e,t,s)=>{let{id:r}=e.params;if(!await de.delete(r))return s(new c("No stay found with that ID",404));_&&await _.del("stays:all"),t.status(204).json({status:"success",data:null});})};var v=e=>l(async(t,s,r)=>{try{return await e.parseAsync({body:t.body,query:t.query,params:t.params}),r()}catch(n){if(n instanceof ZodError){let i=n.issues.map(p=>`${p.path.join(".")}: ${p.message}`).join(", ");return r(new c(i,400))}return r(n)}});var k=l(async(e,t,s)=>{let r;if(e.headers.authorization&&e.headers.authorization.startsWith("Bearer")?r=e.headers.authorization.split(" ")[1]:e.cookies.jwt&&(r=e.cookies.jwt),!r)return s(new c("You are not logged in! Please log in to get access.",401));if(!y.SUPABASE_JWT_SECRET)return s(new c("Server misconfiguration: Missing SUPABASE_JWT_SECRET",500));try{let n=er.verify(r,y.SUPABASE_JWT_SECRET),i=n.sub,p=await a.query.users.findFirst({where:eq(u.id,i)});if(!p){let g=n.email||(n.phone?`${n.phone}@phone.staysewa.com`:`no-email-${i}@staysewa.com`);try{p=(await a.insert(u).values({id:i,email:g,fullName:n.user_metadata?.full_name||"StaySewa User",role:n.user_metadata?.role||n.app_metadata?.role||"customer",emailVerified:!!n.email,password:null}).returning())[0];}catch{p=await a.query.users.findFirst({where:eq(u.id,i)});}}if(!p)return s(new c("User could not be synced",500));e.user=p,s();}catch(n){return console.error("JWT Verification Failed:",n),s(new c("Invalid token",401))}}),S=(...e)=>(t,s,r)=>{if(!t.user||!e.includes(t.user.role))return r(new c("You do not have permission to perform this action",403));r();};var ge={createStay:z$1.object({body:z$1.object({name:z$1.string().min(3,"Name must be at least 3 characters"),type:z$1.enum(["hotel","homestay","apartment","room","hostel"]),intent:z$1.enum(["short_stay","long_stay","both"]).default("both"),addressLine:z$1.string().min(3,"Address is required"),city:z$1.string().min(2,"City is required"),district:z$1.string().min(2,"District is required"),province:z$1.string().optional(),basePrice:z$1.number().positive("Price must be positive"),maxGuests:z$1.number().int().positive().default(1),amenities:z$1.array(z$1.string()).default([]),rules:z$1.array(z$1.string()).default([]),description:z$1.string().optional(),checkInTime:z$1.string().optional(),checkOutTime:z$1.string().optional(),stayUnits:z$1.array(z$1.object({name:z$1.string().min(1),type:z$1.enum(["room","bed","private_room","entire_place","shared_room"]),maxOccupancy:z$1.number().positive(),basePrice:z$1.number().positive(),quantity:z$1.number().int().positive().default(1),amenities:z$1.array(z$1.string()).default([])})).optional()})}),getStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")})}),updateStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")}),body:z$1.object({name:z$1.string().min(3).optional(),type:z$1.enum(["hotel","homestay","apartment","room","hostel"]).optional(),basePrice:z$1.number().positive().optional(),addressLine:z$1.string().optional(),city:z$1.string().optional(),district:z$1.string().optional(),amenities:z$1.array(z$1.string()).optional(),rules:z$1.array(z$1.string()).optional()})}),deleteStay:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Stay ID")})})};var Oe={async create(e){let t=await a.query.bookings.findFirst({where:and(eq(o.id,e.bookingId),eq(o.customerId,e.userId))});if(!t)throw new c("Booking not found or access denied",404);if(await a.query.reviews.findFirst({where:eq(z.bookingId,e.bookingId)}))throw new c("You have already reviewed this stay",400);let[r]=await a.insert(z).values({bookingId:e.bookingId,stayId:t.stayId,userId:e.userId,rating:e.rating,comment:e.comment}).returning();return r},async getByStay(e){return await a.query.reviews.findMany({where:eq(z.stayId,e),orderBy:[desc(z.createdAt)],with:{user:{columns:{name:true}}}})},async getStats(e){return (await a.select({averageRating:sql`avg(${z.rating})::numeric(10,1)`,count:sql`count(*)`}).from(z).where(eq(z.stayId,e)))[0]||{averageRating:"0",count:0}}};var ft={createReview:l(async(e,t,s)=>{let{bookingId:r,rating:n,comment:i}=e.body,p=e.user?.id;if(!p)return t.status(401).json({status:"fail",message:"Unauthorized"});let g=await Oe.create({bookingId:r,rating:n,comment:i,userId:p});t.status(201).json({status:"success",data:{review:g}});}),getStayReviews:l(async(e,t,s)=>{let{stayId:r}=e.params,n=Array.isArray(r)?r[0]:r,i=await Oe.getByStay(n),p=await Oe.getStats(n);t.status(200).json({status:"success",data:{reviews:i,stats:p}});})};var Ce=Router({mergeParams:true});Ce.use(k);Ce.route("/").post(S("user"),ft.createReview);var gt=Router({mergeParams:true});gt.route("/stay/:stayId").get(ft.getStayReviews);var V=Router();V.use("/:stayId/reviews",gt);V.get("/",le.getAllStays);V.get("/:id",v(ge.getStay),le.getStay);V.use(k);V.post("/",S("owner","admin"),v(ge.createStay),le.createStay);V.patch("/:id",S("owner","admin"),v(ge.updateStay),le.updateStay);V.delete("/:id",S("owner","admin"),v(ge.deleteStay),le.deleteStay);var zt=V;var wt={async acquireLock(e,t=5e3){if(!_)return f.warn("Redis not configured, skipping lock acquisition (unsafe for production concurrency)"),"mock-token";let s=Math.random().toString(36).substring(2)+Date.now().toString(36);try{return await _.set(e,s,"PX",t,"NX")==="OK"?s:null}catch(r){return f.error(r,`Failed to acquire lock for key ${e}`),null}},async releaseLock(e,t){if(!(!_||t==="mock-token"))try{await _.eval(`
                if redis.call("get", KEYS[1]) == ARGV[1] then
                    return redis.call("del", KEYS[1])
                else
                    return 0
                end
            `,1,e,t);}catch(s){f.error(s,`Failed to release lock for key ${e}`);}}};var ee={async findOverlap(e,t,s){return await a.query.bookings.findFirst({where:and(eq(o.unitId,e),ne(o.status,"cancelled"),lt(o.checkIn,s),gt$1(o.checkOut,t))})},async getAll(){return await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).orderBy(desc(o.createdAt))},async getById(e){return (await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name,specialRequests:o.id}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.id,e)))[0]||null},async create(e){let t=`booking_lock:${e.unitId||e.stayId}`,s=await wt.acquireLock(t,1e4);if(!s)throw new c("Property is currently being booked by someone else. Please try again in a moment.",409);try{return await a.transaction(async r=>{let n=0;if(e.unitId){let M=await r.query.stayUnits.findFirst({where:eq(D.id,e.unitId)});if(!M)throw new c("Unit not found",404);if(M.stayId!==e.stayId)throw new c("Unit does not belong to this stay",400);n=M.basePrice;}else {let M=await r.query.stays.findFirst({where:eq(d.id,e.stayId)});if(!M)throw new c("Stay not found",404);n=M.basePrice;}let i=new Date(e.checkIn),p=new Date(e.checkOut),g=Math.ceil((p.getTime()-i.getTime())/(1e3*60*60*24));if(g<1)throw new c("Invalid duration",400);e.totalAmount=n*g;let C=["reserved","confirmed","checked_in","completed"];if(e.unitId&&await r.query.bookings.findFirst({where:and(eq(o.unitId,e.unitId),sql`${o.status} IN ('reserved', 'confirmed', 'checked_in', 'completed')`,lt(o.checkIn,e.checkOut),gt$1(o.checkOut,e.checkIn))}))throw new c("The unit is already booked for the selected dates",400);e.bookingNumber||(e.bookingNumber=`STY-${Date.now()}-${Math.random().toString(36).substring(7).toUpperCase()}`),e.status="reserved",e.paymentStatus="pending";let F=new Date;return F.setHours(F.getHours()+1),e.expiresAt=F,(await r.insert(o).values(e).returning())[0]})}finally{await wt.releaseLock(t,s);}},async transitionStatus(e,t){return await a.transaction(async s=>{let r=await s.query.bookings.findFirst({where:eq(o.id,e)});if(!r)throw new c("Booking not found",404);let n=r.status;if(!({initiated:["reserved","cancelled"],reserved:["confirmed","cancelled","expired"],confirmed:["completed","cancelled","checked_in"],checked_in:["completed","cancelled"],completed:[],cancelled:[],expired:[]}[n]||[]).includes(t))throw new c(`Invalid status transition from ${n} to ${t}`,400);return (await s.update(o).set({status:t,updatedAt:new Date,...t==="confirmed"?{confirmedAt:new Date}:{},...t==="cancelled"?{cancelledAt:new Date}:{}}).where(eq(o.id,e)).returning())[0]})},async getMyBookings(e){return await a.select({id:o.id,guestName:o.guestName,guestEmail:o.guestEmail,guestPhone:o.guestPhone,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.customerId,e)).orderBy(desc(o.createdAt))},async getBookingsByOwner(e){return await a.select({id:o.id,guestName:o.guestName,checkIn:o.checkIn,checkOut:o.checkOut,status:o.status,totalAmount:o.totalAmount,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).where(eq(o.ownerId,e)).orderBy(desc(o.createdAt))}};var te={getAllBookings:l(async(e,t,s)=>{let r=await ee.getAll();t.status(200).json({status:"success",results:r.length,data:{bookings:r}});}),getBooking:l(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Booking ID is required",400));let n=await ee.getById(r);if(!n)return s(new c("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:n}});}),createBooking:l(async(e,t,s)=>{let{stayId:r,unitId:n,checkIn:i,checkOut:p,guestName:g,guestEmail:C,guestPhone:F}=e.body;if(!r||!i||!p)return s(new c("Missing required fields: stayId, checkIn, checkOut",400));let fe={...e.body,userId:e.user?e.user.id:void 0},M=await ee.create(fe);t.status(201).json({status:"success",data:{booking:M}});}),updateBookingStatus:l(async(e,t,s)=>{let{id:r}=e.params,{status:n}=e.body;if(!n)return s(new c("Status is required",400));let i=await ee.transitionStatus(r,n);if(!i)return s(new c("No booking found with that ID",404));t.status(200).json({status:"success",data:{booking:i}});}),getMyBookings:l(async(e,t,s)=>{let r=await ee.getMyBookings(e.user.id);t.status(200).json({status:"success",results:r.length,data:{bookings:r}});}),getOwnerBookings:l(async(e,t,s)=>{let r=await ee.getBookingsByOwner(e.user.id);t.status(200).json({status:"success",results:r.length,data:{bookings:r}});})};var Be={createBooking:z$1.object({body:z$1.object({stayId:z$1.uuid("Invalid Stay ID"),unitId:z$1.uuid("Invalid Unit ID"),checkIn:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-in date format (YYYY-MM-DD)"),checkOut:z$1.string().regex(/^\d{4}-\d{2}-\d{2}$/,"Invalid check-out date format (YYYY-MM-DD)"),totalAmount:z$1.number().positive("Total amount must be positive")})}),getBooking:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Booking ID")})}),updateStatus:z$1.object({params:z$1.object({id:z$1.string().uuid("Invalid Booking ID")}),body:z$1.object({status:z$1.enum(["pending","confirmed","checked_in","completed","cancelled","no_show"])})})};var se=Router();se.get("/",k,S("admin"),te.getAllBookings);se.get("/my",k,te.getMyBookings);se.get("/my-stays-bookings",k,S("owner","admin"),te.getOwnerBookings);se.get("/:id",k,v(Be.getBooking),te.getBooking);se.post("/",k,v(Be.createBooking),te.createBooking);se.patch("/:id/status",k,S("owner","admin"),v(Be.updateStatus),te.updateBookingStatus);var Vt=se;var Y={async getDashboardStats(e){let[t]=await a.select({value:count()}).from(d).where(eq(d.ownerId,e)),[s]=await a.select({value:count()}).from(o).where(eq(o.ownerId,e)),[r]=await a.select({total:sql`COALESCE(SUM(${N.amount}), 0)`}).from(N).innerJoin(o,eq(N.bookingId,o.id)).where(and(eq(o.ownerId,e),eq(N.status,"completed")));return {stays:t.value,bookings:s.value,revenue:r.total}},async getRecentActivity(e,t=5){return await a.select({id:o.id,guestName:o.guestName,status:o.status,amount:o.totalAmount,checkIn:o.checkIn,stayName:d.name}).from(o).innerJoin(d,eq(o.stayId,d.id)).where(eq(o.ownerId,e)).limit(t).orderBy(sql`${o.createdAt} DESC`)},async getAll(){return await a.select().from(u).where(eq(u.role,"owner"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"owner"))))[0]||null},async create(e){let t={...e,role:"owner"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"owner"))))[0]||null}};var Pe={getAllOwners:l(async(e,t,s)=>{let r=await Y.getAll();t.status(200).json({status:"success",results:r.length,data:{owners:r}});}),getOwner:l(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Owner ID is required",400));let n=await Y.getById(r);if(!n)return s(new c("No owner found with that ID",404));t.status(200).json({status:"success",data:{owner:n}});}),createOwner:l(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new c("Email is required",400));if(await Y.getByEmail(r))return s(new c("Owner with this email already exists",400));let i=await Y.create(e.body);t.status(201).json({status:"success",data:{owner:i}});})};var je=Router();je.get("/",Pe.getAllOwners);je.get("/:id",Pe.getOwner);je.post("/",Pe.createOwner);var Gt=je;var be={async getAll(){return await a.select().from(u).where(eq(u.role,"customer"))},async getById(e){return (await a.select().from(u).where(and(eq(u.id,e),eq(u.role,"customer"))))[0]||null},async create(e){let t={...e,role:"customer"};return (await a.insert(u).values(t).returning())[0]},async getByEmail(e){return (await a.select().from(u).where(and(eq(u.email,e),eq(u.role,"customer"))))[0]||null}};var Fe={getAllCustomers:l(async(e,t,s)=>{let r=await be.getAll();t.status(200).json({status:"success",results:r.length,data:{customers:r}});}),getCustomer:l(async(e,t,s)=>{let{id:r}=e.params;if(!r)return s(new c("Customer ID is required",400));let n=await be.getById(r);if(!n)return s(new c("No customer found with that ID",404));t.status(200).json({status:"success",data:{customer:n}});}),createCustomer:l(async(e,t,s)=>{let{email:r}=e.body;if(!r)return s(new c("Email is required",400));if(await be.getByEmail(r))return s(new c("Customer with this email already exists",400));let i=await be.create(e.body);t.status(201).json({status:"success",data:{customer:i}});})};var De=Router();De.get("/",Fe.getAllCustomers);De.get("/:id",Fe.getCustomer);De.post("/",Fe.createCustomer);var Zt=De;var _t={getProfile:async(e,t,s)=>{try{let r={id:"user_123",email:"user@example.com",role:"customer",createdAt:new Date};return t.status(200).json({status:"success",data:{user:r}})}catch(r){s(r);}},listUsers:async(e,t,s)=>{try{return t.status(200).json({status:"success",data:{users:[]}})}catch(r){s(r);}}};var kt=Router();kt.get("/profile",_t.getProfile);kt.get("/",_t.listUsers);var Qt=kt;var me={async addMedia(e){return (await a.insert(w).values(e).returning())[0]},async getMediaByStay(e,t=false){let s=t?and(eq(w.stayId,e),isNull(w.unitId)):eq(w.stayId,e);return await a.select().from(w).where(s).orderBy(w.sortOrder)},async getMediaByUnit(e){return await a.select().from(w).where(eq(w.unitId,e)).orderBy(w.sortOrder)},async deleteMedia(e){return (await a.delete(w).where(eq(w.id,e)).returning())[0]},async setCover(e,t,s){return await a.transaction(async r=>{let n=s?and(eq(w.stayId,t),eq(w.unitId,s)):and(eq(w.stayId,t),isNull(w.unitId));return await r.update(w).set({isCover:false}).where(n),(await r.update(w).set({isCover:true}).where(eq(w.id,e)).returning())[0]})},async updateMedia(e,t){return (await a.update(w).set({...t}).where(eq(w.id,e)).returning())[0]}};var pe={uploadMedia:l(async(e,t,s)=>{let{stayId:r,unitId:n,type:i,caption:p,isCover:g}=e.body,{url:C}=e.body;if(e.file&&(C=`${e.protocol}://${e.get("host")}/uploads/${e.file.filename}`),!r||!C)return s(new c("Stay ID and URL/File are required",400));let F=await me.addMedia({stayId:r,unitId:n||null,url:C,type:i||"image",caption:p,isCover:g==="true"||g===true});t.status(201).json({status:"success",data:{media:F}});}),getStayMedia:l(async(e,t,s)=>{let{stayId:r}=e.params,{propertyOnly:n}=e.query;if(!r)return s(new c("Stay ID is required",400));let i=await me.getMediaByStay(r,n==="true");t.status(200).json({status:"success",results:i.length,data:{media:i}});}),getUnitMedia:l(async(e,t,s)=>{let{unitId:r}=e.params;if(!r)return s(new c("Unit ID is required",400));let n=await me.getMediaByUnit(r);t.status(200).json({status:"success",results:n.length,data:{media:n}});}),setCover:l(async(e,t,s)=>{let{id:r}=e.params,{stayId:n,unitId:i}=e.body;if(!n)return s(new c("Stay ID is required in body",400));let p=await me.setCover(r,n,i);t.status(200).json({status:"success",data:{media:p}});}),removeMedia:l(async(e,t,s)=>{let{id:r}=e.params;if(!await me.deleteMedia(r))return s(new c("No media found with that ID",404));t.status(204).json({status:"success",data:null});})};var lr=ts.diskStorage({destination:(e,t,s)=>{s(null,"uploads/");},filename:(e,t,s)=>{let r=Date.now()+"-"+Math.round(Math.random()*1e9);s(null,t.fieldname+"-"+r+dr.extname(t.originalname));}}),mr=(e,t,s)=>{t.mimetype.startsWith("image/")?s(null,true):s(new c("Not an image! Please upload only images.",400),false);},ss=ts({storage:lr,fileFilter:mr,limits:{fileSize:5*1024*1024}});var ye=Router();ye.post("/",ss.single("file"),pe.uploadMedia);ye.delete("/:id",pe.removeMedia);ye.patch("/:id/cover",pe.setCover);ye.get("/stays/:stayId",pe.getStayMedia);ye.get("/units/:unitId",pe.getUnitMedia);var rs=ye;var $e={generateToken(e){return er.sign({id:e},y.JWT_SECRET,{expiresIn:y.JWT_EXPIRES_IN})},async comparePasswords(e,t){return await os.compare(e,t)},async login(e,t){let s=await a.query.users.findFirst({where:eq(u.email,e)});if(!s||!s.password||!await this.comparePasswords(t,s.password))return null;let{password:n,...i}=s;return i},async signup(e){let t=await os.hash(e.password,12),r=(await a.insert(u).values({...e,password:t}).returning())[0],{password:n,...i}=r;return i}};var re={sendTokenCookie(e,t,s){let r=$e.generateToken(e.id),n={expires:new Date(Date.now()+parseInt(process.env.JWT_COOKIE_EXPIRES_IN||"30",10)*24*60*60*1e3),httpOnly:true,secure:process.env.NODE_ENV==="production",sameSite:process.env.NODE_ENV==="production"?"none":"lax"};s.cookie("jwt",r,n),s.status(t).json({status:"success",token:r,data:{user:e}});},signup:l(async(e,t,s)=>{let{email:r,password:n,fullName:i,role:p}=e.body;if(!r||!n||!i)return s(new c("Please provide email, password and full name",400));let g=await $e.signup({email:r,password:n,fullName:i,role:p||"customer"});re.sendTokenCookie(g,201,t);}),login:l(async(e,t,s)=>{let{email:r,password:n}=e.body;if(!r||!n)return s(new c("Please provide email and password",400));let i=await $e.login(r,n);if(!i)return s(new c("Incorrect email or password",401));re.sendTokenCookie(i,200,t);}),logout:(e,t)=>{t.cookie("jwt","loggedout",{expires:new Date(Date.now()+10*1e3),httpOnly:true}),t.status(200).json({status:"success"});},getMe:(e,t)=>{t.status(200).json({status:"success",data:{user:e.user}});}};var Nt={signup:z$1.object({body:z$1.object({fullName:z$1.string().min(2,"Full name must be at least 2 characters"),email:z$1.string().email("Invalid email address"),password:z$1.string().min(8,"Password must be at least 8 characters"),role:z$1.enum(["customer","owner","admin"]).optional()})}),login:z$1.object({body:z$1.object({email:z$1.string().email("Invalid email address"),password:z$1.string().min(1,"Password is required")})})};var _e=Router();_e.post("/signup",v(Nt.signup),re.signup);_e.post("/login",v(Nt.login),re.login);_e.get("/logout",re.logout);_e.get("/me",k,re.getMe);var ns=_e;var vt={async notify(e){return f.info({to:e.userId,title:e.title,body:e.body},"Notification Dispatched"),true},async sendBookingConfirmation(e){return this.notify({userId:e.userId,title:"Booking Confirmed! \u{1F389}",body:`Your booking ${e.bookingNumber} for ${e.stayName} has been confirmed. Total Paid: NPR ${e.totalAmount}.`,meta:{bookingNumber:e.bookingNumber}})},async notifyOwnerOfNewBooking(e){return this.notify({userId:e.ownerId,title:"New Booking Received!",body:`${e.guestName} just booked your property. Booking Reference: ${e.bookingNumber}.`,meta:{bookingNumber:e.bookingNumber}})}};var Ue={async initiateKhalti(e,t){let s=await a.query.bookings.findFirst({where:eq(o.id,e)});if(!s)throw new c("Booking not found",404);let r={return_url:`${y.CORS_ORIGIN}/payment/verify`,website_url:y.CORS_ORIGIN,amount:t*100,purchase_order_id:s.id,purchase_order_name:`Booking ${s.bookingNumber}`};try{let n=await is.post(`${y.KHALTI_BASE_URL}/epayment/initiate/`,r,{headers:{Authorization:`Key ${y.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}});return await a.insert(N).values({bookingId:s.id,userId:s.customerId,amount:t,method:"khalti",gatewayTxnId:n.data.pidx,status:"initiated"}),n.data}catch(n){let i=n;throw f.error(i.response?.data||i.message,"Khalti Initiation Failed"),new c("Failed to initiate payment with Khalti",502)}},async finalizePayment(e,t,s){return await a.transaction(async r=>{if((await r.query.payments.findFirst({where:eq(N.gatewayTxnId,e)}))?.status==="completed")return {success:true,message:"Payment already processed"};await r.update(N).set({status:"completed",paidAt:new Date,gatewayResponse:s}).where(eq(N.gatewayTxnId,e));let[i]=await r.update(o).set({paymentStatus:"paid",status:"confirmed",confirmedAt:new Date}).where(eq(o.id,t)).returning();if(i){let p=await r.query.stays.findFirst({where:eq(d.id,i.stayId)});vt.sendBookingConfirmation({userId:i.customerId,bookingNumber:i.bookingNumber,stayName:p?.name||"Stay",totalAmount:i.totalAmount}).catch(g=>f.error(g,"Guest Notification Failed")),vt.notifyOwnerOfNewBooking({ownerId:i.ownerId,bookingNumber:i.bookingNumber,guestName:i.guestName}).catch(g=>f.error(g,"Owner Notification Failed"));}return {success:true,message:"Payment verified and booking confirmed"}})},async verifyKhalti(e){try{let t=await is.post(`${y.KHALTI_BASE_URL}/epayment/lookup/`,{pidx:e},{headers:{Authorization:`Key ${y.KHALTI_SECRET_KEY}`,"Content-Type":"application/json"}}),{status:s,purchase_order_id:r}=t.data;return s==="Completed"?await this.finalizePayment(e,r,t.data):{success:!1,status:s,message:"Payment not completed"}}catch(t){let s=t;throw f.error(s.response?.data||s.message,"Khalti Verification Failed"),new c("Failed to verify payment with Khalti",502)}},async handleKhaltiWebhook(e){let{pidx:t,status:s,purchase_order_id:r}=e;if(s==="Completed"){f.info({pidx:t,purchase_order_id:r},"Received Khalti Webhook: Verifying...");try{let n=await this.verifyKhalti(t);return n.success?(f.info({pidx:t},"Webhook Verification Successful"),{success:!0,message:"Payment verified and processed via webhook"}):(f.warn({pidx:t,verification:n},"Webhook Verification Failed: Payment not completed based on lookup"),{success:!1,message:"Webhook verification failed"})}catch(n){return f.error(n,"Webhook Verification Error"),{success:false,message:"Error verifying webhook payload"}}}return f.warn({pidx:t,status:s},"Received Non-Completed Khalti Webhook or invalid status"),{success:false,message:"Webhook ignored: status not completed"}}};var Me={initiate:l(async(e,t)=>{let{bookingId:s,amount:r}=e.body,n=await Ue.initiateKhalti(s,r);t.status(200).json({status:"success",data:n});}),verify:l(async(e,t)=>{let{pidx:s}=e.body,r=await Ue.verifyKhalti(s);t.status(200).json({status:"success",data:r});}),webhook:l(async(e,t)=>{let s=await Ue.handleKhaltiWebhook(e.body);t.status(200).json({status:"success",data:s});})};var It={initiate:z$1.object({body:z$1.object({bookingId:z$1.uuid("Invalid Booking ID"),amount:z$1.number().positive("Amount must be positive")})}),verify:z$1.object({body:z$1.object({pidx:z$1.string().min(1,"PIDX is required")})})};var Re=Router();Re.post("/webhook/khalti",Me.webhook);Re.use(k);Re.post("/initiate",v(It.initiate),Me.initiate);Re.post("/verify",v(It.verify),Me.verify);var as=Re;var ie={async getStats(){let[e]=await a.select({count:count()}).from(u),[t]=await a.select({count:count()}).from(o),[s]=await a.select({count:count()}).from(d),[r]=await a.select({total:sql`COALESCE(SUM(${N.amount}), 0)`}).from(N).where(eq(N.status,"completed"));return {users:e.count,bookings:t.count,stays:s.count,revenue:r.total}},async getRecentActivity(e=10){return await a.select({id:o.id,guestName:o.guestName,status:o.status,amount:o.totalAmount,createdAt:o.createdAt}).from(o).limit(e).orderBy(sql`${o.createdAt} DESC`)},async getAllOwners(e=1,t=10,s=""){let r=(e-1)*t,n=and(eq(u.role,"owner"),s?or(ilike(u.fullName,`%${s}%`),ilike(u.email,`%${s}%`)):void 0),i=await a.select({id:u.id,name:u.fullName,email:u.email,avatar:u.avatarUrl,isActive:u.isActive,createdAt:u.createdAt,businessName:P.businessName,verificationStatus:P.verificationStatus,totalEarnings:P.totalEarnings}).from(u).leftJoin(P,eq(u.id,P.userId)).where(n).limit(t).offset(r).orderBy(desc(u.createdAt)),[p]=await a.select({count:count()}).from(u).where(n);return {owners:i,total:p.count,page:e,totalPages:Math.ceil(p.count/t)}},async verifyOwner(e){let[t]=await a.select().from(P).where(eq(P.userId,e));if(!t)throw new Error("Owner profile not found");return await a.update(P).set({verificationStatus:"verified"}).where(eq(P.userId,e)).returning()},async banOwner(e,t){return await a.update(u).set({isActive:!t}).where(eq(u.id,e)).returning()},async getAllBookings(e=1,t=10){let s=(e-1)*t,r=await a.select({id:o.id,bookingNumber:o.bookingNumber,guestName:o.guestName,amount:o.totalAmount,status:o.status,checkIn:o.checkIn,checkOut:o.checkOut,createdAt:o.createdAt,stayName:d.name}).from(o).leftJoin(d,eq(o.stayId,d.id)).limit(t).offset(s).orderBy(desc(o.createdAt)),[n]=await a.select({count:count()}).from(o);return {bookings:r,total:n.count,page:e,totalPages:Math.ceil(n.count/t)}}};var ae={getStats:l(async(e,t)=>{let s=await ie.getStats();t.status(200).json({status:"success",data:{stats:s}});}),getRecentActivity:l(async(e,t)=>{let s=await ie.getRecentActivity();t.status(200).json({status:"success",data:{activity:s}});}),getAllOwners:l(async(e,t)=>{let s=Number(e.query.page)||1,r=Number(e.query.limit)||10,n=e.query.search||"",i=await ie.getAllOwners(s,r,n);t.status(200).json({status:"success",data:i});}),verifyOwner:l(async(e,t)=>{let s=e.params.id;await ie.verifyOwner(s),t.status(200).json({status:"success",message:"Owner verified successfully"});}),banOwner:l(async(e,t)=>{let{ban:s}=e.body,r=e.params.id;await ie.banOwner(r,s),t.status(200).json({status:"success",message:`Owner ${s?"banned":"unbanned"} successfully`});}),getAllBookings:l(async(e,t)=>{let s=Number(e.query.page)||1,r=Number(e.query.limit)||10,n=await ie.getAllBookings(s,r);t.status(200).json({status:"success",data:n});})};var W=Router();W.use(k);W.use(S("admin"));W.get("/stats",ae.getStats);W.get("/activity",ae.getRecentActivity);W.get("/owners",ae.getAllOwners);W.patch("/owners/:id/verify",ae.verifyOwner);W.patch("/owners/:id/ban",ae.banOwner);W.get("/bookings",ae.getAllBookings);var ls=W;var xt={getStats:l(async(e,t,s)=>{let r=e.user?.id;if(!r)return s(new c("User context not found",401));let n=await Y.getDashboardStats(r);t.status(200).json({status:"success",data:{stats:n}});}),getRecentActivity:l(async(e,t,s)=>{let r=e.user?.id;if(!r)return s(new c("User context not found",401));let n=await Y.getRecentActivity(r);t.status(200).json({status:"success",data:{activity:n}});})};var ve=Router();ve.use(k);ve.use(S("owner"));ve.get("/stats",xt.getStats);ve.get("/activity",xt.getRecentActivity);var ms=ve;var O=Router();O.use("/auth",ns);O.use("/stays",zt);O.use("/bookings",Vt);O.use("/owners",Gt);O.use("/customers",Zt);O.use("/users",Qt);O.use("/media",rs);O.use("/payments",as);O.use("/reviews",Ce);O.use("/admin",ls);O.use("/owner/dashboard",ms);var ps=O;var j=At(),Ar=rateLimit({windowMs:900*1e3,max:100,message:"Too many requests from this IP, please try again after 15 minutes",standardHeaders:true,legacyHeaders:false});j.use(vr());j.use(Ar);j.use(Nr({origin:y.CORS_ORIGIN,credentials:true}));j.use(At.json());j.use(Ir());j.use("/uploads",At.static("uploads"));j.get("/health",(e,t)=>{t.status(200).json({status:"success",message:"StaySewa API is healthy"});});j.use("/api",ps);j.use((e,t,s)=>{s(new c(`Can't find ${e.originalUrl} on this server!`,404));});j.use(St);var ys=j;var fs=async()=>{try{let e=new Date,t=await a.update(o).set({status:"expired",updatedAt:new Date}).where(and(eq(o.status,"reserved"),lt(o.expiresAt,e))).returning({id:o.id});t.length>0&&f.info(`[Cron] Expired ${t.length} stale bookings.`);}catch(e){f.error(e,"[Cron] Failed to run booking expiry job");}};var Or=async()=>{try{let e=y.PORT||8e3;Tr.schedule("* * * * *",()=>{fs();}),ys.listen(e,()=>{console.log(`\u{1F680} Production-ready server running at http://localhost:${e}`),console.log(`\u{1F4E1} Environment: ${y.NODE_ENV}`);});}catch(e){console.error("\u274C Failed to start server:",e),process.exit(1);}};Or();